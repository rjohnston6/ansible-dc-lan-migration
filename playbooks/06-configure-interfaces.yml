---
#==============================================================================
# Playbook: Configure Interfaces in Nexus Dashboard Fabric Controller (NDFC)
#==============================================================================
# Purpose: Deploy Layer 2, Layer 3, and VPC interface configurations to NDFC
#          for the target fabric using profiled interface inventory data
#
# Prerequisites:
#   - Interface inventory files generated by 01-profile-existing-switches.yml
#   - NDFC fabric must already be created and switches added
#   - VPC domains must be configured (for VPC interface deployment)
#
# Inventory Files Used:
#   - fabrics/<fabric>/l2_interfaces.yml - Non-VPC L2 interface configurations
#   - fabrics/<fabric>/l3_interfaces.yml - L3 interface configurations (SVIs, loopbacks, routed)
#   - fabrics/<fabric>/l2_vpc_interfaces.yml - VPC interface configurations (consolidated by vpc_id)
#
# Tags:
#   - deploy-l2-interfaces: Deploy only Layer 2 interfaces
#   - deploy-l3-interfaces: Deploy only Layer 3 interfaces
#   - deploy-vpc-interfaces: Deploy only VPC interfaces
#
# Usage Examples:
#   ansible-playbook 06-configure-interfaces.yml --tags deploy-l2-interfaces
#   ansible-playbook 06-configure-interfaces.yml --tags deploy-l3-interfaces
#   ansible-playbook 06-configure-interfaces.yml --tags deploy-vpc-interfaces
#   ansible-playbook 06-configure-interfaces.yml  # Deploy all interface types
#==============================================================================

#------------------------------------------------------------------------------
# Play 1: Configure Layer 2 Interfaces
#------------------------------------------------------------------------------
# Deploys non-VPC Layer 2 interface configurations including:
#   - Access ports with VLAN assignments
#   - Trunk ports with allowed VLANs and native VLAN
#   - Port-channels (non-VPC)
# 
# Note: VPC interfaces are deployed separately in Play 3
#------------------------------------------------------------------------------
- name: Configure Layer 2 Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-l2-interfaces

  vars:
    target_fabric: mgmt-fabric  # Fabric name in NDFC where interfaces will be deployed

  tasks:
    # Load the profiled L2 interface inventory from file
    - name: Load L2 interface inventory
      set_fact:
        l2_inventory: "{{ lookup('file', '../fabrics/' + target_fabric + '/l2_interfaces.yml') | from_yaml }}"
    
    # Optional: Uncomment to view loaded inventory for validation
    # - name: Display loaded L2 inventory
    #   debug:
    #     var: l2_inventory

    # Generate and display NDFC-format configuration for verification before deployment
    # This helps identify any template issues without making actual changes
    - name: Display generated L2 interface config for each switch
      debug:
        msg: "{{ lookup('template', '../templates/ndfc_interfaces.yml.j2') | from_yaml }}"
      vars:
        switch_name: "{{ item.key }}"
        switch_interfaces: "{{ item.value.interfaces }}"
        interface_type: "l2"
      loop: "{{ l2_inventory.switches | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

    # Deploy L2 interface configurations to NDFC
    # Processes each switch individually to provide clear feedback on deployment status
    # The template converts profiled data to NDFC cisco.dcnm.dcnm_interface format
    - name: Configure L2 interfaces for each switch
      cisco.dcnm.dcnm_interface:
        fabric: "{{ target_fabric }}"
        state: merged
        config: "{{ lookup('template', '../templates/ndfc_interfaces.yml.j2') | from_yaml }}"
      vars:
        switch_name: "{{ item.key }}"
        switch_interfaces: "{{ item.value.interfaces }}"
        interface_type: "l2"
      loop: "{{ l2_inventory.switches | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

#------------------------------------------------------------------------------
# Play 2: Configure Layer 3 Interfaces
#------------------------------------------------------------------------------
# Deploys Layer 3 interface configurations including:
#   - SVIs (Switched Virtual Interfaces / VLAN interfaces)
#   - Loopback interfaces
#   - Routed physical interfaces
#   - Routed port-channels
#   - HSRP configurations (if present)
#   - OSPF configurations (if present)
#------------------------------------------------------------------------------
- name: Configure Layer 3 Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-l3-interfaces

  vars:
    target_fabric: mgmt-fabric  # Fabric name in NDFC where interfaces will be deployed

  tasks:
    # Load the profiled L3 interface inventory from file
    - name: Load L3 interface inventory
      set_fact:
        l3_inventory: "{{ lookup('file', '../fabrics/' + target_fabric + '/l3_interfaces.yml') | from_yaml }}"
    
    # Optional: Uncomment to view loaded inventory for validation
    # - name: Display loaded L3 inventory
    #   debug:
    #     var: l3_inventory

    # Generate and display NDFC-format configuration for verification before deployment
    - name: Display generated L3 interface config for each switch
      debug:
        msg: "{{ lookup('template', '../templates/ndfc_interfaces.yml.j2') | from_yaml }}"
      vars:
        switch_name: "{{ item.key }}"
        switch_interfaces: "{{ item.value.interfaces }}"
        interface_type: "l3"
      loop: "{{ l3_inventory.switches | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

    # Deploy L3 interface configurations to NDFC
    # Includes IP addressing, HSRP, OSPF, and DHCP relay settings
    - name: Configure L3 interfaces for each switch
      cisco.dcnm.dcnm_interface:
        fabric: "{{ target_fabric }}"
        state: merged
        config: "{{ lookup('template', '../templates/ndfc_interfaces.yml.j2') | from_yaml }}"
      vars:
        switch_name: "{{ item.key }}"
        switch_interfaces: "{{ item.value.interfaces }}"
        interface_type: "l3"
      loop: "{{ l3_inventory.switches | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

#------------------------------------------------------------------------------
# Play 3: Configure VPC Interfaces
#------------------------------------------------------------------------------
# Deploys VPC (Virtual Port Channel) interface configurations
# 
# VPC interfaces are consolidated by vpc_id during profiling, meaning each VPC
# interface spans two switches (peer1 and peer2). This play deploys:
#   - VPC trunk ports with allowed VLANs
#   - VPC access ports
#   - Port-channel members for each peer
#
# Note: VPC domain must be configured before deploying VPC interfaces
#------------------------------------------------------------------------------
- name: Configure VPC Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-vpc-interfaces

  vars:
    target_fabric: mgmt-fabric  # Fabric name in NDFC where VPC interfaces will be deployed

  tasks:
    # Load the consolidated VPC interface inventory
    # VPCs are consolidated by vpc_id across switch pairs during profiling
    - name: Load VPC consolidated inventory
      set_fact:
        vpc_inventory: "{{ lookup('file', '../fabrics/' + target_fabric + '/l2_vpc_interfaces.yml') | from_yaml }}"
    
    # Optional: Uncomment to view loaded VPC inventory for validation
    # - name: Display loaded VPC inventory
    #   debug:
    #     var: vpc_inventory

    # Generate and display NDFC-format configuration for each VPC
    # Interface names are converted from port-channelXX to vpcXX format
    - name: Display generated VPC interface config for each VPC
      debug:
        msg: "{{ lookup('template', '../templates/ndfc_vpc_interfaces.yml.j2') | from_yaml }}"
      vars:
        vpc_interface: "{{ item }}"
      loop: "{{ vpc_inventory.vpc_interfaces }}"
      loop_control:
        label: "VPC {{ item.vpc_id }}: {{ item.name }}"

    # Deploy VPC interface configurations to NDFC
    # Each VPC is deployed as a single entity spanning both switches
    # Member interfaces are automatically configured on peer1 and peer2
    - name: Configure VPC interfaces
      cisco.dcnm.dcnm_interface:
        fabric: "{{ target_fabric }}"
        state: merged
        config: "{{ lookup('template', '../templates/ndfc_vpc_interfaces.yml.j2') | from_yaml }}"
      vars:
        vpc_interface: "{{ item }}"
      loop: "{{ vpc_inventory.vpc_interfaces }}"
      loop_control:
        label: "VPC {{ item.vpc_id }}: {{ item.name }}"
