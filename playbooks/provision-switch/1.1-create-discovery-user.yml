---
# Playbook: 1.1-create-discovery-user.yml
# Purpose: Configure NDFC discovery user on pre-provisioned switches via NDFC
#
# Description:
#   This playbook configures the switch_user policy on switches to allow NDFC
#   to authenticate during switch discovery by:
#   1. Building list of switches with add_to_fabric: true
#   2. Querying existing policies to check if switch_user already exists
#   3. Creating switch_user policy via bulk-create API for new switches
#
# Variables Required (per switch in hosts.yml):
#   - add_to_fabric: Set to true to include switch in provisioning
#   - destination_switch_sn: Target switch serial number
#
# Variables from Vault (vault.yml):
#   - vault_discovery_username: Username for NDFC switch discovery
#   - vault_discovery_password: Password for NDFC switch discovery
#
# Module Used:
#   - cisco.dcnm.dcnm_rest (httpapi connection - uses nd group credentials)
#
# API Endpoints Used:
#   - POST /appcenter/cisco/ndfc/api/v1/lan-discovery/setCredential
#
# Templates Used:
#   - 1.1-create-discovery-user.j2: Jinja2 template for switch_user policy JSON payload
#
# Tags:
#   - create-discovery-user: Run only discovery user provisioning tasks
#
# Example Usage:
#   ansible-playbook ./playbooks/provision-switch/1.1-create-discovery-user.yml
#   ansible-playbook ./playbooks/provision-switch/1.1-create-discovery-user.yml --tags create-discovery-user

- name: Configure Discovery User on Pre-provisioned Switches
  hosts: nexus_dashboard
  gather_facts: false

  tags:
    - create-discovery-user

  vars:
    # Default discovery credentials - override in vault for production
    discovery_username: "{{ vault_discovery_username | default('ndfc') }}"
    discovery_password: "{{ vault_discovery_password | default(vault_switch_password) }}"

  tasks:

    #--------------------------------------------------------------------------
    # Pre-flight: Verify NDFC is reachable before any provisioning
    #--------------------------------------------------------------------------
    - name: Verify NDFC connectivity
      ansible.builtin.import_tasks: ../common/ndfc-preflight-check.yml

    # ========================================================================
    # Phase 1: Build list of switches to provision
    # ========================================================================

    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    # Build fabric paths from nd_fabrics for targeted file searches
    - name: Build fabric paths from nd_fabrics
      ansible.builtin.import_tasks: ../common/build-fabric-paths.yml
      when: switches_to_provision | length > 0

    # Load switch_details.yml to get serial numbers for discovered switches
    - name: Find switch_details.yml files
      ansible.builtin.find:
        paths: "{{ fabric_paths }}"
        patterns: "switch_details.yml"
      delegate_to: localhost
      register: switch_details_files

    - name: Load switch details from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item }}"
        name: "switch_details_{{ item | dirname | basename | replace('-', '_') }}"
      loop: "{{ switch_details_files.files | map(attribute='path') | list }}"
      loop_control:
        label: "{{ item | dirname | basename }}"

    - name: Build consolidated switch details lookup (keyed by IP)
      ansible.builtin.set_fact:
        switch_details_lookup: |
          {%- set lookup = {} -%}
          {%- for var_name in hostvars[inventory_hostname] | select('match', '^switch_details_') -%}
            {%- set details = hostvars[inventory_hostname][var_name] -%}
            {%- if details.switches is defined -%}
              {%- for switch in details.switches -%}
                {%- set _ = lookup.update({switch.ip_address: switch}) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}

    - name: End play if no switches to provision
      ansible.builtin.meta: end_play
      when: switches_to_provision | length == 0

    # ========================================================================
    # Phase 2: Build setCredential payload data
    # ========================================================================

    - name: Build switch list for setCredential payload
      ansible.builtin.set_fact:
        setcredential_switches: |
          {%- set switches = [] -%}
          {%- for switch in switches_to_provision -%}
            {%- set ip = switch.ansible_host | default('') -%}
            {%- set details = switch_details_lookup.get(ip, {}) if switch_details_lookup is defined else {} -%}
            {%- set sw = {
              'ipAddress': ip,
              'model': details.model | default(''),
              'serialNumber': details.license_hostid | default(''),
              'sysName': switch.inventory_hostname
            } -%}
            {%- set _ = switches.append(sw) -%}
          {%- endfor -%}
          {{ switches }}
        seed_ips: "{{ switches_to_provision | map(attribute='ansible_host') | join(',') }}"

    - name: Display switches to set discovery credentials for
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          DISCOVERY CREDENTIAL PROVISIONING (setCredential)
          ═══════════════════════════════════════════════════════════════════════
          Switches: {{ setcredential_switches | length }}
          Seed IPs: {{ seed_ips }}
          Discovery username: {{ discovery_username }}
          {% for sw in setcredential_switches %}
          - {{ sw.sysName }} ({{ sw.ipAddress }}) SN={{ sw.serialNumber }} model={{ sw.model }}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════

    # ========================================================================
    # Phase 3: Set discovery credentials via NDFC setCredential API
    # ========================================================================

    - name: Set discovery credentials for switches
      cisco.dcnm.dcnm_rest:
        path: "/appcenter/cisco/ndfc/api/v1/lan-discovery/setCredential"
        method: POST
        json_data: "{{ _payload | to_json if _payload is mapping else _payload }}"
      vars:
        ansible_network_os: cisco.dcnm.dcnm
        _payload: "{{ lookup('template', '../../templates/1.1-create-discovery-user.j2') }}"
      register: setcredential_result

    # ========================================================================
    # Phase 4: Display results
    # ========================================================================

    - name: Display setCredential results
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          DISCOVERY CREDENTIAL RESULTS
          ═══════════════════════════════════════════════════════════════════════
          Status: {{ 'SUCCESS' if (setcredential_result.failed is not defined or not setcredential_result.failed) else 'FAILED' }}
          Switches configured: {{ setcredential_switches | length }}
          {% for sw in setcredential_switches %}
          - {{ sw.sysName }} ({{ sw.ipAddress }})
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: setcredential_result is defined
