---
# Playbook: 1.3-deploy-vpc-domain.yml
# Purpose: Configure and deploy VPC domain to Nexus Dashboard using REST API
#
# Description:
#   This playbook configures VPC domains on aggregation switches by:
#   1. Querying switches to get serial numbers and IP addresses
#   2. Checking if VPC pairs already exist in NDFC via REST API
#   3. Building VPC pair configuration from J2 template
#   4. Deploying VPC domains via cisco.nd.nd_rest module
#
# Variables Required:
#   - vpc_domains: List of VPC domain definitions (from fabric_definitions.yml)
#
# Module Used:
#   - cisco.nd.nd_rest: ND REST API module for VPC pair management
#
# API Endpoint:
#   - /appcenter/cisco/ndfc/api/v1/lan-fabric/rest/vpcpair
#
# Templates Used:
#   - 1.3-deploy-vpc-domain.json.j2: Jinja2 template for VPC pair API payload
#
# Tags:
#   - deploy-vpc-domain: Run only VPC domain deployment tasks
#
# Example Usage:
#   ansible-playbook ./playbooks/provision-switch/1.3-deploy-vpc-domain.yml

- name: Configure and Deploy VPC Domain in Nexus Dashboard
  hosts: nexus_dashboard
  gather_facts: false

  vars:
    ansible_command_timeout: 300
    ansible_connect_timeout: 300
    ansible_persistent_command_timeout: 300
    vpc_api_path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/vpcpair"

  tags:
    - deploy-vpc-domain

  tasks:

    #--------------------------------------------------------------------------
    # Pre-flight: Verify NDFC is reachable before any provisioning
    #--------------------------------------------------------------------------
    - name: Verify NDFC connectivity
      ansible.builtin.import_tasks: ../common/ndfc-preflight-check.yml

    # ========================================================================
    # Phase 1: Early exit check
    # ========================================================================

    - name: Set target fabric name from nd_fabrics
      ansible.builtin.set_fact:
        target_fabric: "{{ nd_fabrics[0].FABRIC_NAME }}"

    - name: Filter VPC domains to target fabric only
      ansible.builtin.set_fact:
        vpc_domains_filtered: "{{ vpc_domains | default([]) | selectattr('FABRIC_NAME', 'equalto', target_fabric) | list }}"

    - name: End play if no VPC domains defined
      ansible.builtin.meta: end_play
      when: vpc_domains_filtered | length == 0

    # ========================================================================
    # Phase 2: Query switches to get IP addresses and serial numbers
    # ========================================================================

    - name: Query all switches in target fabric
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/api/v1/manage/fabrics/{{ target_fabric }}/switches"
        method: GET
      register: fabric_switches_query

    - name: Build switch lookup by IP address
      ansible.builtin.set_fact:
        switch_lookup: |
          {%- set lookup = {target_fabric: {}} -%}
          {%- if fabric_switches_query.current is defined and fabric_switches_query.current.switches is defined -%}
            {%- for switch in fabric_switches_query.current.switches -%}
              {%- if switch.fabricManagementIp is defined -%}
                {%- set _ = lookup[target_fabric].update({switch.fabricManagementIp: {'serial': switch.serialNumber, 'ip': switch.fabricManagementIp, 'hostname': switch.hostname | default('')}}) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {{ lookup }}

    # ========================================================================
    # Phase 3: Build VPC domain configurations with IP addresses and serials
    # ========================================================================

    - name: Build VPC domain configurations
      ansible.builtin.set_fact:
        vpc_domains_to_deploy: |
          {%- set domains = [] -%}
          {%- for domain in vpc_domains_filtered -%}
            {%- set fabric = domain.FABRIC_NAME -%}
            {%- if fabric in switch_lookup -%}
              {%- set fabric_switches = switch_lookup[fabric] -%}
              {# Resolve inventory hostnames to IP addresses via hostvars #}
              {%- set peer1_ip = hostvars[domain.PEER1_NAME]['ansible_host'] | default('') if domain.PEER1_NAME in hostvars else '' -%}
              {%- set peer2_ip = hostvars[domain.PEER2_NAME]['ansible_host'] | default('') if domain.PEER2_NAME in hostvars else '' -%}
              {%- if peer1_ip in fabric_switches and peer2_ip in fabric_switches -%}
                {%- set peer1_info = fabric_switches[peer1_ip] -%}
                {%- set peer2_info = fabric_switches[peer2_ip] -%}
                {%- set updated = domain | combine({
                  'PEER1_IP': peer1_info.ip,
                  'PEER2_IP': peer2_info.ip,
                  'PEER1_SERIAL': peer1_info.serial,
                  'PEER2_SERIAL': peer2_info.serial
                }) -%}
                {%- set _ = domains.append(updated) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ domains }}

    - name: Display VPC domain deployment plan
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          VPC DOMAIN DEPLOYMENT PLAN
          ═══════════════════════════════════════════════════════════════════════
          Total defined: {{ vpc_domains_filtered | length }}
          To deploy: {{ vpc_domains_to_deploy | length }}
          {% for domain in vpc_domains_to_deploy %}
          - {{ domain.FABRIC_NAME }}: Domain {{ domain.DOMAIN_ID }} ({{ domain.PEER1_NAME }} <-> {{ domain.PEER2_NAME }})
            Peer1 Serial: {{ domain.PEER1_SERIAL }}
            Peer2 Serial: {{ domain.PEER2_SERIAL }}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════

    # ========================================================================
    # Phase 4: Check for existing VPC pairs in NDFC via REST API
    # ========================================================================

    - name: Query existing VPC pairs in NDFC
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "{{ vpc_api_path }}"
        method: GET
      when: vpc_domains_to_deploy | length > 0
      register: existing_vpc_pairs

    - name: Build set of existing VPC pair serial numbers
      ansible.builtin.set_fact:
        existing_vpc_serials: |
          {%- set serials = [] -%}
          {%- for vpc in existing_vpc_pairs.current | default([]) -%}
            {%- set _ = serials.append(vpc.peerOneId | default('')) -%}
            {%- set _ = serials.append(vpc.peerTwoId | default('')) -%}
          {%- endfor -%}
          {{ serials | unique | reject('equalto', '') | list }}
      when: existing_vpc_pairs is defined

    - name: Filter out VPC domains where switches already have VPC configured
      ansible.builtin.set_fact:
        vpc_domains_to_create: |
          {%- set to_create = [] -%}
          {%- for domain in vpc_domains_to_deploy -%}
            {%- set ns = namespace(vpc_exists=false) -%}
            {%- for vpc in existing_vpc_pairs.current | default([]) -%}
              {# Check if both peer serials match an existing VPC pair (in either order) #}
              {%- if (vpc.peerOneId == domain.PEER1_SERIAL and vpc.peerTwoId == domain.PEER2_SERIAL) or
                     (vpc.peerOneId == domain.PEER2_SERIAL and vpc.peerTwoId == domain.PEER1_SERIAL) -%}
                {%- set ns.vpc_exists = true -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if not ns.vpc_exists -%}
              {%- set _ = to_create.append(domain) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ to_create }}
      when: existing_vpc_pairs is defined

    - name: Display VPC creation status
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          VPC PAIR STATUS CHECK
          ═══════════════════════════════════════════════════════════════════════
          Existing VPC pairs in NDFC: {{ existing_vpc_pairs.current | default([]) | length }}
          VPC domains to deploy: {{ vpc_domains_to_deploy | length }}
          VPC domains to create (new): {{ vpc_domains_to_create | default([]) | length }}
          VPC domains already configured: {{ vpc_domains_to_deploy | length - (vpc_domains_to_create | default([]) | length) }}
          {% if existing_vpc_pairs.current | default([]) | length > 0 %}
          
          Existing VPC pairs:
          {% for vpc in existing_vpc_pairs.current | default([]) %}
            - ID {{ vpc.id }}: {{ vpc.peerOneName | default(vpc.peerOneId) }} ({{ vpc.peerOneId }}) <-> {{ vpc.peerTwoName | default(vpc.peerTwoId) }} ({{ vpc.peerTwoId }})
          {% endfor %}
          {% endif %}
          ═══════════════════════════════════════════════════════════════════════
      when: existing_vpc_pairs is defined

    # ========================================================================
    # Phase 5: Skip if all VPC pairs already exist
    # ========================================================================

    - name: Skip VPC deployment - all VPC pairs already exist
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          VPC DOMAIN DEPLOYMENT SKIPPED
          ═══════════════════════════════════════════════════════════════════════
          All VPC pairs already exist in NDFC. No new VPC pairs to create.
          ═══════════════════════════════════════════════════════════════════════
      when: vpc_domains_to_create | default([]) | length == 0 and vpc_domains_to_deploy | length > 0

    # ========================================================================
    # Phase 6: Deploy VPC domains via REST API
    # ========================================================================

    - name: Display VPC pairs to create
      ansible.builtin.debug:
        msg: |
          Creating {{ vpc_domains_to_create | length }} VPC pair(s):
          {% for domain in vpc_domains_to_create %}
          - Domain {{ domain.DOMAIN_ID }} on {{ domain.PEER1_SERIAL }} <-> {{ domain.PEER2_SERIAL }}
          {% endfor %}
      when: vpc_domains_to_create | default([]) | length > 0

    - name: Create VPC pairs via REST API
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "{{ vpc_api_path }}"
        method: POST
        content: "{{ lookup('template', playbook_dir + '/../../templates/1.3-deploy-vpc-domain.json.j2') }}"
      loop: "{{ vpc_domains_to_create | default([]) }}"
      loop_control:
        label: "Domain {{ item.DOMAIN_ID }}: {{ item.PEER1_NAME }} <-> {{ item.PEER2_NAME }}"
      register: vpc_create_results
      ignore_errors: true
      when: vpc_domains_to_create | default([]) | length > 0

    - name: Display VPC creation results
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          VPC DOMAIN CREATION RESULTS
          ═══════════════════════════════════════════════════════════════════════
          {% for result in vpc_create_results.results | default([]) %}
          - Domain {{ result.item.DOMAIN_ID }}: {{ 'SUCCESS' if result.current is defined else 'FAILED' }}
            {{ result.item.PEER1_NAME }} ({{ result.item.PEER1_SERIAL }}) <-> {{ result.item.PEER2_NAME }} ({{ result.item.PEER2_SERIAL }})
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: vpc_create_results.results is defined

    # ========================================================================
    # Phase 7: Deploy VPC configuration to switches
    # ========================================================================

    - name: Deploy VPC configuration to switches
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ item.FABRIC_NAME }}/config-deploy"
        method: POST
        content: |
          {
            "switches": ["{{ item.PEER1_SERIAL }}", "{{ item.PEER2_SERIAL }}"]
          }
      loop: "{{ vpc_domains_to_create | default([]) }}"
      loop_control:
        label: "Deploy Domain {{ item.DOMAIN_ID }}"
      register: vpc_deploy_results
      ignore_errors: true
      when: vpc_domains_to_create | default([]) | length > 0

    - name: Display VPC deployment results
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          VPC DOMAIN DEPLOYMENT RESULTS
          ═══════════════════════════════════════════════════════════════════════
          {% for result in vpc_deploy_results.results | default([]) %}
          - Domain {{ result.item.DOMAIN_ID }}: {{ 'DEPLOYED' if result.current is defined else 'FAILED' }}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: vpc_deploy_results.results is defined

    # ========================================================================
    # Phase 8: Query and display configured VPC pairs
    # ========================================================================

    - name: Query all configured VPC domains
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "{{ vpc_api_path }}"
        method: GET
      register: all_vpc_pairs_query
      when: vpc_domains_to_deploy | length > 0

    - name: Display configured VPC domain details
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          CONFIGURED VPC DOMAINS
          ═══════════════════════════════════════════════════════════════════════
          Total VPC Domains: {{ all_vpc_pairs_query.current | default([]) | length }}
          {% for vpc in all_vpc_pairs_query.current | default([]) %}
          
          Domain {{ vpc.nvPairs.DOMAIN_ID | default('N/A') }}:
            Fabric: {{ vpc.nvPairs.FABRIC_NAME | default('N/A') }}
            Peer 1: {{ vpc.peerOneId | default('N/A') }}
            Peer 2: {{ vpc.peerTwoId | default('N/A') }}
            PC Mode: {{ vpc.nvPairs.PC_MODE | default('N/A') }}
            Allowed VLANs: {{ vpc.nvPairs.ALLOWED_VLANS | default('N/A') }}
            Keepalive VRF: {{ vpc.nvPairs.KEEP_ALIVE_VRF | default('N/A') }}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: all_vpc_pairs_query is defined
