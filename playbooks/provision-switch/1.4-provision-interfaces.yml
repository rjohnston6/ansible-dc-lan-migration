---
#==============================================================================
# Playbook: Configure Interfaces in Nexus Dashboard Fabric Controller (NDFC)
#==============================================================================
# Purpose: Deploy Layer 2 and VPC interface configurations to NDFC
#          for the target fabric using profiled interface inventory data
#
# Module: cisco.dcnm.dcnm_interface
#   - Provides declarative state management (merged/replaced)
#   - Automatically handles create vs update (idempotent)
#   - Supports Ethernet, Port-channel, and VPC interface types
#
# Prerequisites:
#   - Interface inventory files generated by 1.0-profile-existing-switches.yml
#   - NDFC fabric must already be created and switches added
#   - VPC domains must be configured (for VPC interface deployment)
#
# Inventory Files Used:
#   - fabrics/<fabric>/l2_interfaces.yml - Non-VPC L2 interface configurations
#   - fabrics/<fabric>/l2_vpc_interfaces.yml - VPC interface configurations
#
# Templates Used:
#   - templates/1.4-provision-interfaces-eth.yml.j2 - Ethernet interface config
#   - templates/1.4-provision-interfaces-pc.yml.j2 - Port-channel interface config
#   - templates/1.4-provision-interfaces-vpc.yml.j2 - VPC interface config
#
# Tags:
#   - deploy-l2-interfaces: Deploy only Layer 2 interfaces
#   - deploy-vpc-interfaces: Deploy only VPC interfaces
#
# Usage Examples:
#   ansible-playbook 1.4-provision-interfaces.yml --tags deploy-l2-interfaces
#   ansible-playbook 1.4-provision-interfaces.yml --tags deploy-vpc-interfaces
#   ansible-playbook 1.4-provision-interfaces.yml  # Deploy all interface types
#==============================================================================

#------------------------------------------------------------------------------
# Play 1: Configure Layer 2 Interfaces (Ethernet and Port-channels)
#------------------------------------------------------------------------------
# Uses dcnm_interface module with state=replaced for idempotent configuration
# - Automatically creates new interfaces
# - Updates existing interfaces if configuration differs
# - Deploys configuration to switches
#------------------------------------------------------------------------------
- name: Configure Layer 2 Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-l2-interfaces

  tasks:
    #--------------------------------------------------------------------------
    # Setup: Build list of switches to provision
    #--------------------------------------------------------------------------
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    - name: Display switches to provision
      ansible.builtin.debug:
        msg: "Provisioning {{ switches_to_provision | length }} switch(es): {{ switches_to_provision | map(attribute='inventory_hostname') | list }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Load L2 interface inventory from fabric directories
    #--------------------------------------------------------------------------
    - name: Find all l2_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l2_interfaces.yml"
        recurse: true
      register: l2_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load L2 interfaces data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "l2_data_{{ item.path | dirname | basename }}"
      loop: "{{ l2_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build consolidated L2 interfaces lookup
    #--------------------------------------------------------------------------
    - name: Build consolidated L2 interfaces lookup
      ansible.builtin.set_fact:
        l2_interfaces_lookup: >-
          {%- set lookup = {} -%}
          {%- for file in l2_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'l2_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: {'interfaces': data.interfaces | default([]), 'fabric': fabric_name}}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Configure Ethernet Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build Ethernet interface configuration from template
      ansible.builtin.set_fact:
        eth_interface_config: "{{ lookup('template', playbook_dir + '/../../templates/1.4-provision-interfaces-eth.yml.j2') | from_json }}"
      when:
        - switches_to_provision | length > 0
        - l2_interfaces_lookup is defined

    - name: Display Ethernet interfaces to configure
      ansible.builtin.debug:
        msg: "Configuring {{ eth_interface_config | length }} Ethernet interface(s)"
      when: eth_interface_config is defined and eth_interface_config | length > 0

    - name: Configure Ethernet interfaces via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: true
        config: "{{ eth_interface_config }}"
      when:
        - switches_to_provision | length > 0
        - eth_interface_config is defined
        - eth_interface_config | length > 0
      register: eth_deploy_result

    - name: Display Ethernet interface deployment result
      ansible.builtin.debug:
        msg: |
          Ethernet Interface Deployment Result:
          - Changed: {{ eth_deploy_result.changed | default(false) }}
          - Response: {{ eth_deploy_result.response | default([]) | length }} operation(s)
      when: eth_deploy_result is defined

    #--------------------------------------------------------------------------
    # Configure Port-channel Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build Port-channel interface configuration from template
      ansible.builtin.set_fact:
        pc_interface_config: "{{ lookup('template', playbook_dir + '/../../templates/1.4-provision-interfaces-pc.yml.j2') | from_json }}"
      when:
        - switches_to_provision | length > 0
        - l2_interfaces_lookup is defined

    - name: Display Port-channel interfaces to configure
      ansible.builtin.debug:
        msg: "Configuring {{ pc_interface_config | length }} Port-channel interface(s)"
      when: pc_interface_config is defined and pc_interface_config | length > 0

    - name: Configure Port-channel interfaces via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: true
        config: "{{ pc_interface_config }}"
      when:
        - switches_to_provision | length > 0
        - pc_interface_config is defined
        - pc_interface_config | length > 0
      register: pc_deploy_result

    - name: Display Port-channel interface deployment result
      ansible.builtin.debug:
        msg: |
          Port-channel Interface Deployment Result:
          - Changed: {{ pc_deploy_result.changed | default(false) }}
          - Response: {{ pc_deploy_result.response | default([]) | length }} operation(s)
      when: pc_deploy_result is defined


#------------------------------------------------------------------------------
# Play 2: Configure VPC Interfaces
#------------------------------------------------------------------------------
# Uses dcnm_interface module with state=replaced for idempotent VPC config
# - VPC interfaces span two switches (peer1 and peer2)
# - Automatically creates or updates VPC interface configuration
# - VPC domain must be configured before deploying VPC interfaces
#------------------------------------------------------------------------------
- name: Configure VPC Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-vpc-interfaces

  tasks:
    #--------------------------------------------------------------------------
    # Setup: Build list of switches to provision
    #--------------------------------------------------------------------------
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    #--------------------------------------------------------------------------
    # Load VPC interface inventory from fabric directories
    #--------------------------------------------------------------------------
    - name: Find all l2_vpc_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l2_vpc_interfaces.yml"
        recurse: true
      register: vpc_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load VPC interfaces data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "vpc_data_{{ item.path | dirname | basename }}"
      loop: "{{ vpc_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build consolidated VPC interfaces lookup (per fabric)
    #--------------------------------------------------------------------------
    - name: Build consolidated VPC interfaces lookup
      ansible.builtin.set_fact:
        vpc_interfaces_by_fabric: >-
          {%- set lookup = {} -%}
          {%- for file in vpc_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'vpc_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set vpc_data = hostvars[inventory_hostname][var_name] -%}
              {%- if vpc_data.vpc_interfaces is defined -%}
                {%- set _ = lookup.update({fabric_name: vpc_data.vpc_interfaces}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    - name: Get unique fabrics from switches to provision
      ansible.builtin.set_fact:
        fabrics_to_process: "{{ switches_to_provision | map(attribute='fabric') | unique | list }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build VPC interface configuration from template
    #--------------------------------------------------------------------------
    - name: Build VPC interface configuration from template
      ansible.builtin.set_fact:
        vpc_interface_config: "{{ lookup('template', playbook_dir + '/../../templates/1.4-provision-interfaces-vpc.yml.j2') | from_json }}"
      when:
        - switches_to_provision | length > 0
        - vpc_interfaces_by_fabric is defined
        - fabrics_to_process is defined

    - name: Display VPC interfaces to configure
      ansible.builtin.debug:
        msg: |
          Configuring {{ vpc_interface_config | length }} VPC interface(s):
          {% for vpc in vpc_interface_config %}
          - {{ vpc.name }}: {{ vpc.profile.mode }} mode, peers {{ vpc.switch[0] }}
          {% endfor %}
      when: vpc_interface_config is defined and vpc_interface_config | length > 0

    #--------------------------------------------------------------------------
    # Configure VPC Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Configure VPC interfaces via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ fabrics_to_process[0] }}"
        state: replaced
        check_deploy: true
        config: "{{ vpc_interface_config }}"
      when:
        - switches_to_provision | length > 0
        - vpc_interface_config is defined
        - vpc_interface_config | length > 0
        - fabrics_to_process | length > 0
      register: vpc_deploy_result

    - name: Display VPC interface deployment result
      ansible.builtin.debug:
        msg: |
          VPC Interface Deployment Result:
          - Changed: {{ vpc_deploy_result.changed | default(false) }}
          - Response: {{ vpc_deploy_result.response | default([]) | length }} operation(s)
          {% if vpc_deploy_result.diff is defined %}
          - Diff: {{ vpc_deploy_result.diff | length }} difference(s) detected
          {% endif %}
      when: vpc_deploy_result is defined
