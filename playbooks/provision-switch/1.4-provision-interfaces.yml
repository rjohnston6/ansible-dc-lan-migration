---
#==============================================================================
# Playbook: Configure Interfaces in Nexus Dashboard Fabric Controller (NDFC)
#==============================================================================
# Purpose: Deploy Layer 2, VPC, and SVI interface configurations to NDFC
#          for the target fabric using profiled interface inventory data
#
# Module: cisco.dcnm.dcnm_interface
#   - Provides declarative state management (merged/replaced)
#   - Automatically handles create vs update (idempotent)
#   - Supports Ethernet, Port-channel, VPC, and SVI interface types
#
# Prerequisites:
#   - Interface inventory files generated by 1.0-profile-existing-switches.yml
#   - NDFC fabric must already be created and switches added
#   - VPC domains must be configured (for VPC interface deployment)
#   - VLANs must exist before configuring SVIs
#
# Inventory Files Used:
#   - fabrics/<fabric>/l2_interfaces.yml - Non-VPC L2 interface configurations
#   - fabrics/<fabric>/l2_vpc_interfaces.yml - VPC interface configurations
#   - fabrics/<fabric>/l3_interfaces.yml - L3/SVI interface configurations
#
# Templates Used:
#   - templates/1.4-provision-interfaces-eth.j2 - Ethernet interface config
#   - templates/1.4-provision-interfaces-pc.j2 - Port-channel interface config
#   - templates/1.4-provision-interfaces-vpc.j2 - VPC interface config
#   - templates/1.4-provision-interfaces-svi.j2 - SVI interface config
#
# Tags:
#   - deploy-l2-interfaces: Deploy only Layer 2 interfaces (Ethernet/Port-channel)
#   - deploy-vpc-interfaces: Deploy only VPC interfaces
#   - deploy-svi-interfaces: Deploy only SVI (VLAN) interfaces
#
# Usage Examples:
#   ansible-playbook 1.4-provision-interfaces.yml --tags deploy-l2-interfaces
#   ansible-playbook 1.4-provision-interfaces.yml --tags deploy-vpc-interfaces
#   ansible-playbook 1.4-provision-interfaces.yml --tags deploy-svi-interfaces
#   ansible-playbook 1.4-provision-interfaces.yml  # Deploy all interface types
#==============================================================================

#------------------------------------------------------------------------------
# Play 1: Configure Layer 2 Interfaces (Ethernet and Port-channels)
#------------------------------------------------------------------------------
# Uses dcnm_interface module with state=replaced for idempotent configuration
# - Automatically creates new interfaces
# - Updates existing interfaces if configuration differs
# - Deploys configuration to switches
#------------------------------------------------------------------------------
- name: Configure Layer 2 Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-l2-interfaces

  tasks:
    #--------------------------------------------------------------------------
    # Setup: Build list of switches to provision
    #--------------------------------------------------------------------------
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    - name: Display switches to provision
      ansible.builtin.debug:
        msg: "Provisioning {{ switches_to_provision | length }} switch(es): {{ switches_to_provision | map(attribute='inventory_hostname') | list }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Load L2 interface inventory from fabric directories
    #--------------------------------------------------------------------------
    - name: Find all l2_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l2_interfaces.yml"
        recurse: true
      register: l2_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load L2 interfaces data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "l2_data_{{ item.path | dirname | basename }}"
      loop: "{{ l2_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build consolidated L2 interfaces lookup
    #--------------------------------------------------------------------------
    - name: Build consolidated L2 interfaces lookup
      ansible.builtin.set_fact:
        l2_interfaces_lookup: >-
          {%- set lookup = {} -%}
          {%- for file in l2_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'l2_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: {'interfaces': data.interfaces | default([]), 'fabric': fabric_name}}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Configure Ethernet Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build Ethernet interface configuration from template
      ansible.builtin.set_fact:
        eth_interface_config: "{{ lookup('template', playbook_dir + '/../../templates/1.4-provision-interfaces-eth.j2') | from_json }}"
      when:
        - switches_to_provision | length > 0
        - l2_interfaces_lookup is defined

    #--------------------------------------------------------------------------
    # Separate interfaces by switch role for deployment strategy
    #--------------------------------------------------------------------------
    - name: Separate Ethernet interfaces by switch role (aggregation vs access/POAP)
      ansible.builtin.set_fact:
        eth_interface_config_agg: "{{ eth_interface_config | selectattr('switch', 'in', agg_switches) | list }}"
        eth_interface_config_access: "{{ eth_interface_config | rejectattr('switch', 'in', agg_switches) | list }}"
      vars:
        agg_switches: "{{ switches_to_provision | selectattr('role', 'equalto', 'aggregation') | map(attribute='inventory_hostname') | list }}"
      when:
        - eth_interface_config is defined
        - eth_interface_config | length > 0

    - name: Display Ethernet interfaces to configure
      ansible.builtin.debug:
        msg: |
          Configuring {{ eth_interface_config | length }} Ethernet interface(s):
          - Aggregation switches: {{ eth_interface_config_agg | length }}
          - Access/POAP switches: {{ eth_interface_config_access | length }}
      when: eth_interface_config is defined and eth_interface_config | length > 0

    #--------------------------------------------------------------------------
    # Configure Ethernet interfaces on aggregation switches (check_deploy: true)
    #--------------------------------------------------------------------------
    - name: Configure Ethernet interfaces on aggregation switches via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: true
        config: "{{ eth_interface_config_agg }}"
      when:
        - switches_to_provision | length > 0
        - eth_interface_config_agg is defined
        - eth_interface_config_agg | length > 0
      register: eth_deploy_result_agg

    - name: Display Ethernet interface deployment result (aggregation)
      ansible.builtin.debug:
        msg: |
          Aggregation Ethernet Interface Deployment Result:
          - Changed: {{ eth_deploy_result_agg.changed | default(false) }}
          - Response: {{ eth_deploy_result_agg.response | default([]) | length }} operation(s)
      when: eth_deploy_result_agg is defined

    #--------------------------------------------------------------------------
    # Configure Ethernet interfaces on access/POAP switches (check_deploy: false)
    #--------------------------------------------------------------------------
    - name: Configure Ethernet interfaces on access/POAP switches via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: false
        config: "{{ eth_interface_config_access }}"
      when:
        - switches_to_provision | length > 0
        - eth_interface_config_access is defined
        - eth_interface_config_access | length > 0
      register: eth_deploy_result_access

    - name: Display Ethernet interface deployment result (access/POAP)
      ansible.builtin.debug:
        msg: |
          Access/POAP Ethernet Interface Deployment Result:
          - Changed: {{ eth_deploy_result_access.changed | default(false) }}
          - Response: {{ eth_deploy_result_access.response | default([]) | length }} operation(s)
          - Note: Deployment check skipped for POAP switches - policies will deploy after bootstrap
      when: eth_deploy_result_access is defined

    #--------------------------------------------------------------------------
    # Configure Port-channel Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build Port-channel interface configuration from template
      ansible.builtin.set_fact:
        pc_interface_config: "{{ lookup('template', playbook_dir + '/../../templates/1.4-provision-interfaces-pc.j2') | from_json }}"
      when:
        - switches_to_provision | length > 0
        - l2_interfaces_lookup is defined

    - name: Separate Port-channel interfaces by switch role (aggregation vs access/POAP)
      ansible.builtin.set_fact:
        pc_interface_config_agg: "{{ pc_interface_config | selectattr('switch', 'in', agg_switches) | list }}"
        pc_interface_config_access: "{{ pc_interface_config | rejectattr('switch', 'in', agg_switches) | list }}"
      vars:
        agg_switches: "{{ switches_to_provision | selectattr('role', 'equalto', 'aggregation') | map(attribute='inventory_hostname') | list }}"
      when:
        - pc_interface_config is defined
        - pc_interface_config | length > 0

    - name: Display Port-channel interfaces to configure
      ansible.builtin.debug:
        msg: |
          Configuring {{ pc_interface_config | length }} Port-channel interface(s):
          - Aggregation switches: {{ pc_interface_config_agg | length }}
          - Access/POAP switches: {{ pc_interface_config_access | length }}
      when: pc_interface_config is defined and pc_interface_config | length > 0

    - name: Configure Port-channel interfaces on aggregation switches via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: true
        config: "{{ pc_interface_config_agg }}"
      when:
        - switches_to_provision | length > 0
        - pc_interface_config_agg is defined
        - pc_interface_config_agg | length > 0
      register: pc_deploy_result_agg

    - name: Display Port-channel interface deployment result (aggregation)
      ansible.builtin.debug:
        msg: |
          Aggregation Port-channel Interface Deployment Result:
          - Changed: {{ pc_deploy_result_agg.changed | default(false) }}
          - Response: {{ pc_deploy_result_agg.response | default([]) | length }} operation(s)
      when: pc_deploy_result_agg is defined

    - name: Configure Port-channel interfaces on access/POAP switches via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: false
        config: "{{ pc_interface_config_access }}"
      when:
        - switches_to_provision | length > 0
        - pc_interface_config_access is defined
        - pc_interface_config_access | length > 0
      register: pc_deploy_result_access

    - name: Display Port-channel interface deployment result (access/POAP)
      ansible.builtin.debug:
        msg: |
          Access/POAP Port-channel Interface Deployment Result:
          - Changed: {{ pc_deploy_result_access.changed | default(false) }}
          - Response: {{ pc_deploy_result_access.response | default([]) | length }} operation(s)
          - Note: Deployment check skipped for POAP switches - policies will deploy after bootstrap
      when: pc_deploy_result_access is defined


#------------------------------------------------------------------------------
# Play 2: Configure VPC Interfaces
#------------------------------------------------------------------------------
# Uses dcnm_interface module with state=replaced for idempotent VPC config
# - VPC interfaces span two switches (peer1 and peer2)
# - Automatically creates or updates VPC interface configuration
# - VPC domain must be configured before deploying VPC interfaces
#------------------------------------------------------------------------------
- name: Configure VPC Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-vpc-interfaces

  tasks:
    #--------------------------------------------------------------------------
    # Setup: Build list of switches to provision
    #--------------------------------------------------------------------------
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    #--------------------------------------------------------------------------
    # Load VPC interface inventory from fabric directories
    #--------------------------------------------------------------------------
    - name: Find all l2_vpc_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l2_vpc_interfaces.yml"
        recurse: true
      register: vpc_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load VPC interfaces data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "vpc_data_{{ item.path | dirname | basename }}"
      loop: "{{ vpc_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build consolidated VPC interfaces lookup (per fabric)
    #--------------------------------------------------------------------------
    - name: Build consolidated VPC interfaces lookup
      ansible.builtin.set_fact:
        vpc_interfaces_by_fabric: >-
          {%- set lookup = {} -%}
          {%- for file in vpc_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'vpc_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set vpc_data = hostvars[inventory_hostname][var_name] -%}
              {%- if vpc_data.vpc_interfaces is defined -%}
                {%- set _ = lookup.update({fabric_name: vpc_data.vpc_interfaces}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    - name: Get unique fabrics from switches to provision
      ansible.builtin.set_fact:
        fabrics_to_process: "{{ switches_to_provision | map(attribute='fabric') | unique | list }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build VPC interface configuration from template
    #--------------------------------------------------------------------------
    - name: Build VPC interface configuration from template
      ansible.builtin.set_fact:
        vpc_interface_config: "{{ lookup('template', playbook_dir + '/../../templates/1.4-provision-interfaces-vpc.j2') | from_json }}"
      when:
        - switches_to_provision | length > 0
        - vpc_interfaces_by_fabric is defined
        - fabrics_to_process is defined

    - name: Display VPC interfaces to configure
      ansible.builtin.debug:
        msg: |
          Configuring {{ vpc_interface_config | length }} VPC interface(s):
          {% for vpc in vpc_interface_config %}
          - {{ vpc.name }}: {{ vpc.profile.mode }} mode, peers {{ vpc.switch[0] }}
          {% endfor %}
      when: vpc_interface_config is defined and vpc_interface_config | length > 0

    #--------------------------------------------------------------------------
    # Configure VPC Interfaces using dcnm_interface module
    # VPC interfaces always use check_deploy: true (aggregation switches only)
    #--------------------------------------------------------------------------
    - name: Configure VPC interfaces via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ fabrics_to_process[0] }}"
        state: replaced
        check_deploy: true
        config: "{{ vpc_interface_config }}"
      when:
        - switches_to_provision | length > 0
        - vpc_interface_config is defined
        - vpc_interface_config | length > 0
        - fabrics_to_process | length > 0
      register: vpc_deploy_result

    - name: Display VPC interface deployment result
      ansible.builtin.debug:
        msg: |
          VPC Interface Deployment Result:
          - Changed: {{ vpc_deploy_result.changed | default(false) }}
          - Response: {{ vpc_deploy_result.response | default([]) | length }} operation(s)
          {% if vpc_deploy_result.diff is defined %}
          - Diff: {{ vpc_deploy_result.diff | length }} difference(s) detected
          {% endif %}
      when: vpc_deploy_result is defined


#------------------------------------------------------------------------------
# Play 3: Configure SVI (VLAN) Interfaces
#------------------------------------------------------------------------------
# Uses dcnm_interface module with state=replaced for idempotent SVI config
# - Deploys L3 SVI interfaces (e.g., Vlan199)
# - Configures IP address, VRF, and admin state
# - Requires l3_interfaces.yml generated by discovery playbook
#------------------------------------------------------------------------------
- name: Configure SVI Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-svi-interfaces

  tasks:
    #--------------------------------------------------------------------------
    # Setup: Build list of switches to provision
    #--------------------------------------------------------------------------
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    - name: Display switches to provision
      ansible.builtin.debug:
        msg: "Provisioning SVI interfaces for {{ switches_to_provision | length }} switch(es)"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Load L3 interface data from fabric directories
    #--------------------------------------------------------------------------
    - name: Find all l3_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l3_interfaces.yml"
        recurse: true
      register: l3_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load L3 interface data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "l3_data_{{ item.path | dirname | basename }}"
      loop: "{{ l3_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build consolidated L3 interfaces lookup
    #--------------------------------------------------------------------------
    - name: Build consolidated L3 interfaces lookup
      ansible.builtin.set_fact:
        l3_interfaces_lookup: >-
          {%- set lookup = {} -%}
          {%- for file in l3_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'l3_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: {'interfaces': data.interfaces | default([]), 'fabric': fabric_name}}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    - name: Get unique fabrics from switches to provision
      ansible.builtin.set_fact:
        fabrics_to_process: "{{ switches_to_provision | map(attribute='fabric') | unique | list }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Configure SVI Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build SVI interface configuration from template
      ansible.builtin.set_fact:
        svi_interface_config: "{{ lookup('template', playbook_dir + '/../../templates/1.4-provision-interfaces-svi.j2') | from_json }}"
      when:
        - switches_to_provision | length > 0
        - l3_interfaces_lookup is defined

    - name: Separate SVI interfaces by switch role (aggregation vs access/POAP)
      ansible.builtin.set_fact:
        svi_interface_config_agg: "{{ svi_interface_config | selectattr('switch', 'in', agg_switches) | list }}"
        svi_interface_config_access: "{{ svi_interface_config | rejectattr('switch', 'in', agg_switches) | list }}"
      vars:
        agg_switches: "{{ switches_to_provision | selectattr('role', 'equalto', 'aggregation') | map(attribute='inventory_hostname') | list }}"
      when:
        - svi_interface_config is defined
        - svi_interface_config | length > 0

    - name: Display SVI interfaces to configure (Aggregation)
      ansible.builtin.debug:
        msg: |
          Configuring {{ svi_interface_config_agg | length }} aggregation SVI interface(s):
          {% for svi in svi_interface_config_agg %}
          - {{ svi.name }}: {{ svi.profile.ipv4_addr }}/{{ svi.profile.ipv4_mask_len }} on {{ svi.switch[0] }}
          {% endfor %}
      when: svi_interface_config_agg is defined and svi_interface_config_agg | length > 0

    - name: Display SVI interfaces to configure (Access/POAP)
      ansible.builtin.debug:
        msg: |
          Configuring {{ svi_interface_config_access | length }} access/POAP SVI interface(s):
          {% for svi in svi_interface_config_access %}
          - {{ svi.name }}: {{ svi.profile.ipv4_addr }}/{{ svi.profile.ipv4_mask_len }} on {{ svi.switch[0] }}
          {% endfor %}
      when: svi_interface_config_access is defined and svi_interface_config_access | length > 0

    - name: Configure SVI interfaces (AGGREGATION) via dcnm_interface with check_deploy=true
      cisco.dcnm.dcnm_interface:
        fabric: "{{ fabrics_to_process[0] }}"
        state: replaced
        check_deploy: true
        config: "{{ svi_interface_config_agg }}"
      when:
        - switches_to_provision | length > 0
        - svi_interface_config_agg is defined
        - svi_interface_config_agg | length > 0
        - fabrics_to_process | length > 0
      register: svi_deploy_result_agg

    - name: Display SVI interface deployment result (AGGREGATION)
      ansible.builtin.debug:
        msg: |
          Aggregation SVI Interface Deployment Result:
          - Changed: {{ svi_deploy_result_agg.changed | default(false) }}
          - Response: {{ svi_deploy_result_agg.response | default([]) | length }} operation(s)
          {% if svi_deploy_result_agg.diff is defined %}
          - Diff: {{ svi_deploy_result_agg.diff | length }} difference(s) detected
          {% endif %}
      when: svi_deploy_result_agg is defined

    - name: Configure SVI interfaces (ACCESS/POAP) via dcnm_interface with check_deploy=false
      cisco.dcnm.dcnm_interface:
        fabric: "{{ fabrics_to_process[0] }}"
        state: replaced
        check_deploy: false
        config: "{{ svi_interface_config_access }}"
      when:
        - switches_to_provision | length > 0
        - svi_interface_config_access is defined
        - svi_interface_config_access | length > 0
        - fabrics_to_process | length > 0
      register: svi_deploy_result_access

    - name: Display SVI interface deployment result (ACCESS/POAP)
      ansible.builtin.debug:
        msg: |
          Access/POAP SVI Interface Deployment Result:
          - Changed: {{ svi_deploy_result_access.changed | default(false) }}
          - Response: {{ svi_deploy_result_access.response | default([]) | length }} operation(s)
          - Note: Deployment check skipped for POAP switches - policies will deploy after bootstrap
      when: svi_deploy_result_access is defined
