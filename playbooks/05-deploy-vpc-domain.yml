---
# ============================================================================
# Playbook: Configure and Deploy VPC Domain to Nexus Dashboard
# ============================================================================
# Purpose:
#   - Query Nexus Dashboard for existing aggregation switches in each fabric
#   - Match switch serial numbers from ND with VPC domain peer definitions
#   - Deploy VPC domain configuration via Nexus Dashboard REST API
#   - Configure peer-link port-channels and VPC domain parameters
#
# Prerequisites:
#   - Fabrics must be configured on Nexus Dashboard (playbook 02)
#   - Aggregation switches must be added to fabrics (playbook 03)
#   - VPC domain definitions must exist in host_vars/nexus_dashboard/vpc_domains.yml
#   - vpc_pair template must exist on Nexus Dashboard
#
# Usage:
#   ansible-playbook playbooks/05-deploy-vpc-domain.yml
#   ansible-playbook playbooks/05-deploy-vpc-domain.yml --tags deploy-vpc-domain
#
# Tags:
#   deploy-vpc-domain: Deploy VPC domain configuration to ND
#
# Notes:
#   - Serial numbers from ND are used to identify peer switches
#   - Template renders JSON payload for ND DCNM REST API
#   - API may return response parsing errors even when successful
#   - ignore_errors is used to handle benign API response format issues
# ============================================================================

- name: Configure and Deploy VPC Domain in Nexus Dashboard
  hosts: nexus_dashboard
  gather_facts: false

  tags:
    - deploy-vpc-domain
  
  vars:
    # Target fabric name for single-fabric operations (not currently used)
    target_fabric: mgmt-fabric
    
    # Authentication domain for Nexus Dashboard login
    login_domain: "local"

  tasks:
    
    # ------------------------------------------------------------------------
    # Task 1: Query Nexus Dashboard for Aggregation Switches
    # ------------------------------------------------------------------------
    # Retrieve the list of switches already registered in ND for each fabric,
    # filtered to only aggregation role switches. This provides the actual
    # serial numbers that ND knows about, which must match the VPC peer IDs.
    #
    # API Endpoint: GET /api/v1/manage/fabrics/{fabric}/switches?filter=switchRole:aggregation
    # Returns: { switches: [ { hostname, serialNumber, ip, model, ... }, ... ] }
    # ------------------------------------------------------------------------
    - name: Get Switch Inventory from Nexus Dashboard for Aggregation Switches
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"                        # ND management IP
        username: "{{ ansible_user }}"                    # ND username
        password: "{{ ansible_ssh_pass }}"                # ND password
        use_ssl: "{{ ansible_httpapi_use_ssl }}"          # Use HTTPS
        validate_certs: "{{ ansible_httpapi_validate_certs }}"  # Certificate validation
        use_proxy: "{{ ansible_httpapi_use_proxy }}"      # Proxy settings
        login_domain: "{{ login_domain }}"                # Authentication domain
        method: GET                                        # HTTP GET request
        path: /api/v1/manage/fabrics/{{ item.FABRIC_NAME }}/switches?filter=switchRole%3Aaggregation  # Filter aggregation switches
      loop: "{{ nd_fabrics }}"                            # Loop through all fabrics
      register: existing_switches_per_fabric              # Store results for processing
    
    # ------------------------------------------------------------------------
    # Task 2: Transform Switch Inventory to Simplified Structure
    # ------------------------------------------------------------------------
    # Extract only the necessary fields (hostname and serialNumber) from the
    # full switch inventory response. This creates a cleaner data structure
    # for matching with VPC domain peer definitions.
    #
    # Input: API response with full switch details per fabric
    # Output: [ { fabric: <name>, switches: [ {hostname, serialNumber}, ... ] } ]
    # ------------------------------------------------------------------------
    - name: Transform Switch Inventory into Simplified Structure
      set_fact:
        existing_switches_per_fabric: |                  # Overwrite with simplified structure
          {% set fabrics = [] %}
          {% for result in existing_switches_per_fabric.results %}
          {% set switches = [] %}
          {% for switch in result.jsondata.switches %}
          {% set _ = switches.append({
            'hostname': switch.hostname,
            'serialNumber': switch.serialNumber
          }) %}
          {% endfor %}
          {% set _ = fabrics.append({
            'fabric': result.item.FABRIC_NAME,
            'switches': switches
          }) %}
          {% endfor %}
          {{ fabrics }}
    
    # ------------------------------------------------------------------------
    # Task 3: Display Aggregation Switches (for verification)
    # ------------------------------------------------------------------------
    # Show the simplified switch inventory structure for debugging and validation
    # ------------------------------------------------------------------------
    - name: Display Aggregation Switches by Fabric
      debug:
        var: existing_switches_per_fabric
    
    # ------------------------------------------------------------------------
    # Task 4: Merge Serial Numbers into VPC Domain Definitions
    # ------------------------------------------------------------------------
    # Match VPC domain peer names (PEER1_NAME, PEER2_NAME) with actual switch
    # hostnames from ND to get their serial numbers. The serial numbers are
    # required by the ND API to identify which switches form the VPC pair.
    #
    # Process:
    #   1. For each VPC domain definition
    #   2. Find the fabric's switch list
    #   3. Match PEER1_NAME to hostname, extract serialNumber as PEER_ONE_ID
    #   4. Match PEER2_NAME to hostname, extract serialNumber as PEER_TWO_ID
    #   5. Merge serial numbers into domain definition
    # ------------------------------------------------------------------------
    - name: Merge Aggregation Switch Serial Numbers into VPC Domain setting PEER_ONE_ID and PEER_TWO_ID as the serial numbers that match PEER1_NAME and PEER2_NAME
      set_fact:
        vpc_domains_with_serials: |
          {% set updated_domains = [] %}
          {% for domain in vpc_domains %}
          {% set fabric_switches = (existing_switches_per_fabric | selectattr('fabric', 'equalto', domain.FABRIC_NAME) | first).switches %}
          {% set peer_one_serial = (fabric_switches | selectattr('hostname', 'equalto', domain.PEER1_NAME) | first).serialNumber %}
          {% set peer_two_serial = (fabric_switches | selectattr('hostname', 'equalto', domain.PEER2_NAME) | first).serialNumber %}
          {% set _ = updated_domains.append(domain | combine({'PEER_ONE_ID': peer_one_serial, 'PEER_TWO_ID': peer_two_serial})) %}
          {% endfor %}
          {{ updated_domains }}
    
    # ------------------------------------------------------------------------
    # Task 5: Deploy VPC Domain Configuration to Nexus Dashboard
    # ------------------------------------------------------------------------
    # Submit VPC domain configuration to ND using the DCNM REST API. The
    # vpc_pair.json.j2 template generates the required payload with:
    #   - peerOneId/peerTwoId: Switch serial numbers from ND
    #   - nvPairs: VPC domain parameters (domain ID, keepalive, peer-link config)
    #   - templateName: Policy template on ND (typically 'vpc_pair')
    #
    # API Endpoint: POST /appcenter/cisco/ndfc/api/v1/lan-fabric/rest/vpcpair
    #
    # Known Issue: The API successfully creates the VPC domain but may return
    # a response format that causes the nd_rest module to fail parsing. The
    # actual configuration IS applied successfully despite the error.
    # Using ignore_errors=true to handle this benign API response issue.
    # ------------------------------------------------------------------------
    - name: Deploy VPC Domain to Nexus Dashboard
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"                        # ND management IP
        username: "{{ ansible_user }}"                    # ND username
        password: "{{ ansible_ssh_pass }}"                # ND password
        use_ssl: "{{ ansible_httpapi_use_ssl }}"          # Use HTTPS
        validate_certs: "{{ ansible_httpapi_validate_certs }}"  # Certificate validation
        use_proxy: "{{ ansible_httpapi_use_proxy }}"      # Proxy settings
        login_domain: "{{ login_domain }}"                # Authentication domain
        method: POST                                      # HTTP POST request
        path: /appcenter/cisco/ndfc/api/v1/lan-fabric/rest/vpcpair  # VPC pair API endpoint
        timeout: 300                                      # Extended timeout (VPC config can be slow)
        content: "{{ lookup('template', '../templates/vpc_pair.json.j2') }}"  # Rendered JSON payload
      loop: "{{ vpc_domains_with_serials }}"              # Loop through VPC domains
      loop_control:
        label: "VPC Domain for Fabric {{ item.FABRIC_NAME }}"  # Display friendly label
      register: vpc_deployment_result                     # Capture results
      ignore_errors: true                                 # Ignore response parsing errors
    
    # ------------------------------------------------------------------------
    # Task 6: Display VPC Deployment Result
    # ------------------------------------------------------------------------
    # Show the outcome of VPC domain deployment. Note that 'failed' status
    # may appear even when the configuration was successfully applied due to
    # API response parsing issues. Always verify in Nexus Dashboard UI.
    # ------------------------------------------------------------------------
    - name: Display VPC Deployment Result
      debug:
        msg: "VPC Domain deployed for {{ item.item.FABRIC_NAME }}: {{ 'Success' if item.failed is not defined or not item.failed else 'Check Nexus Dashboard - may have succeeded despite error' }}"
      loop: "{{ vpc_deployment_result.results }}"
      loop_control:
        label: "{{ item.item.FABRIC_NAME }}"