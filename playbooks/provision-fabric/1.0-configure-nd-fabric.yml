---
# Playbook: 1.0-configure-nd-fabric.yml
# Purpose: Deploy fabric configurations to Nexus Dashboard Fabric Controller (NDFC)
#
# Description:
#   This playbook manages fabric creation/update on NDFC using the
#   cisco.dcnm.dcnm_fabric module with state=merged.
#
# Variables Required:
#   - nd_fabrics: List of fabric definitions from host_vars/nexus_dashboard/fabric_definitions.yml
#                 Each fabric should contain FABRIC_NAME and configuration parameters
#   - ansible_host: Nexus Dashboard IP address
#   - ansible_user: ND username
#   - ansible_ssh_pass: ND password
#   - ansible_httpapi_use_ssl: Use SSL for API calls (typically true)
#   - ansible_httpapi_validate_certs: Validate SSL certificates (typically false for lab)
#   - ansible_httpapi_use_proxy: Use proxy for API calls (typically false)
#
# Module Used:
#   - cisco.dcnm.dcnm_fabric: Create/update/query/delete NDFC fabrics
#
# Tags:
#   - configure-fabrics: Run only fabric configuration tasks
#
# Example Usage:
#   ansible-playbook ./playbooks/provision-fabric/1.0-configure-nd-fabric.yml
#   ansible-playbook ./playbooks/provision-fabric/1.0-configure-nd-fabric.yml --tags configure-fabrics

- name: Deploy Fabric Configuration to Nexus Dashboard
  hosts: nexus_dashboard
  gather_facts: false

  vars:
    fabric_type_map:
      classiclan: LAN_CLASSIC
      bgp: BGP
      ipfm: IPFM
      isn: ISN
      vxlanibgp: VXLAN_EVPN
      vxlanevpn: VXLAN_EVPN
      vxlan_evpn: VXLAN_EVPN
      vxlanevpnmsd: VXLAN_EVPN_MSD
      vxlan_evpn_msd: VXLAN_EVPN_MSD

  tags:
    - configure-fabrics

  tasks:

    #--------------------------------------------------------------------------
    # Pre-flight: Verify NDFC is reachable before any provisioning
    #--------------------------------------------------------------------------
    - name: Verify NDFC connectivity
      ansible.builtin.import_tasks: ../common/ndfc-preflight-check.yml

    - name: Build normalized fabric config list for dcnm_fabric
      ansible.builtin.set_fact:
        dcnm_fabrics_config: "{{ (dcnm_fabrics_config | default([])) + [ item | combine({'FABRIC_TYPE': (fabric_type_map[item.FABRIC_TYPE | default('LAN_CLASSIC') | lower] | default(item.FABRIC_TYPE | default('LAN_CLASSIC') | upper))}) ] }}"
      loop: "{{ nd_fabrics | default([]) }}"
      loop_control:
        label: "{{ item.FABRIC_NAME }}"

    - name: Display fabrics to be merged
      ansible.builtin.debug:
        msg: |
          Fabrics to be merged: {{ dcnm_fabrics_config | default([]) | length }}
          {% for fabric in dcnm_fabrics_config | default([]) %}
          - {{ fabric.FABRIC_NAME }} ({{ fabric.FABRIC_TYPE }})
          {% endfor %}

    - name: Configure fabrics in Nexus Dashboard via dcnm_fabric
      cisco.dcnm.dcnm_fabric:
        state: merged
        skip_validation: true
        config: "{{ dcnm_fabrics_config }}"
      vars:
        ansible_network_os: cisco.dcnm.dcnm
      when:
        - dcnm_fabrics_config is defined
        - dcnm_fabrics_config | length > 0
      register: fabric_config_result

    - name: Display fabric configuration results
      ansible.builtin.debug:
        msg: |
          Fabric configuration complete.
          Changed: {{ fabric_config_result.changed | default(false) }}
          Response entries: {{ fabric_config_result.response | default([]) | length }}
      when: fabric_config_result is defined

#  TODO add a step that can do Update to an existing fabric using PUT
