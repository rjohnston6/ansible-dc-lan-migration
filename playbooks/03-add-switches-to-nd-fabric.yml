---
# ============================================================================
# Playbook: Register Brownfield Switches to Nexus Dashboard Fabrics
# ============================================================================
# Purpose:
#   - Read switch inventory CSV files for each fabric
#   - Compare desired switches with existing switches already in ND fabrics
#   - Add only the missing switches to their respective fabrics
#   - Preserve existing switch configurations during onboarding
#
# Prerequisites:
#   - Fabrics must already be configured on Nexus Dashboard (playbook 02)
#   - Switch inventory CSV files must exist at fabrics/{FABRIC_NAME}/switch_inventory.csv
#   - Switches must be reachable via their management IP addresses
#   - Switch credentials (nd_switch_username, nd_switch_password) must be defined
#
# Usage:
#   ansible-playbook playbooks/03-add-switches-to-nd-fabric.yml
#
# Tags:
#   add-switches: Register switches to Nexus Dashboard fabrics
#
# Notes:
#   - Uses nd_rest module to interact with Nexus Dashboard REST API
#   - CSV parsing is done manually using Jinja2 to avoid external dependencies
#   - Only adds switches that don't already exist in the fabric
#   - preserveConfig: true ensures existing configs are retained
# ============================================================================

- name: Register Brownfield Switches to Nexus Dashboard Fabrics
  hosts: nexus_dashboard
  gather_facts: false

  tags:
    - add-switches

  vars:
    # Login domain for Nexus Dashboard authentication
    nd_login_domain: "local"

  tasks:

    # ------------------------------------------------------------------------
    # Task 1: Retrieve Existing Switches from Each Fabric
    # ------------------------------------------------------------------------
    # Query Nexus Dashboard REST API to get the list of switches already
    # registered to each fabric. This allows us to compare and only add
    # switches that are missing.
    #
    # API Endpoint: GET /api/v1/manage/fabrics/{fabric_name}/switches
    # Returns: { switches: [ { hostname, ip, serialNumber, ... }, ... ] }
    # ------------------------------------------------------------------------
    - name: Check ND Fabric for Existing Switches
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"                        # ND management IP
        username: "{{ ansible_user }}"                    # ND username
        password: "{{ ansible_ssh_pass }}"                # ND password
        use_ssl: "{{ ansible_httpapi_use_ssl }}"          # Use HTTPS
        validate_certs: "{{ ansible_httpapi_validate_certs }}"  # Certificate validation
        use_proxy: "{{ ansible_httpapi_use_proxy }}"      # Proxy settings
        login_domain: "{{ nd_login_domain }}"             # Authentication domain
        method: GET                                        # HTTP GET request
        path: /api/v1/manage/fabrics/{{ item.FABRIC_NAME }}/switches  # API path
      loop: "{{ nd_fabrics }}"                            # Loop through all fabrics
      register: existing_switches_per_fabric              # Store results for comparison

    # ------------------------------------------------------------------------
    # Task 2: Display Existing Switches (for verification)
    # ------------------------------------------------------------------------
    # Show which switches are already registered to each fabric before
    # attempting to add new ones. Useful for debugging and validation.
    # ------------------------------------------------------------------------
    - name: Display Existing Switches per Fabric
      debug:
        msg:
          - "Fabric: {{ item.item.FABRIC_NAME }}"
          - "Existing Switches: {{ item.current.switches | map(attribute='hostname') | list }}"
      loop: "{{ existing_switches_per_fabric.results }}"
    
    # ------------------------------------------------------------------------
    # Task 3: Compare and Identify Switches to Add
    # ------------------------------------------------------------------------
    # For each fabric:
    #   1. Read the switch_inventory.csv file from fabrics/{FABRIC_NAME}/
    #   2. Parse CSV manually using Jinja2 (skip header, split by comma)
    #   3. Compare desired switches with existing switches (by hostname)
    #   4. Create a list of only the missing switches that need to be added
    #
    # CSV Format: hostname,ip_address,serial_number,model,role,sw_version
    #
    # This approach avoids adding duplicate switches and prevents API errors.
    # ------------------------------------------------------------------------
    - name: Compare and Identify Switches to be Added
      set_fact:
        switches_to_add: >-
          {{
            switches_to_add | default([]) + [{
              'fabric_name': item.item.FABRIC_NAME,
              'switches': desired_switches | rejectattr('hostname', 'in', item.current.switches | map(attribute='hostname') | list) | list
            }]
          }}
      loop: "{{ existing_switches_per_fabric.results }}"
      vars:
        # Read CSV file content
        csv_content: "{{ lookup('file', '../fabrics/' + item.item.FABRIC_NAME + '/switch_inventory.csv') }}"
        # Split into lines, skip header row [0], remove empty lines
        csv_lines: "{{ csv_content.split('\n')[1:] | reject('equalto', '') | list }}"
        # Parse CSV lines into structured switch dictionaries
        desired_switches: |
          {% set switches = [] %}
          {% for line in csv_lines %}
          {% set fields = line.split(',') %}
          {% set _ = switches.append({
            'hostname': fields[0].strip(),
            'ip_address': fields[1].strip(),
            'serial_number': fields[2].strip(),
            'model': fields[3].strip(),
            'role': fields[4].strip(),
            'sw_version': fields[5].strip()
          }) %}
          {% endfor %}
          {{ switches }}
    
    # ------------------------------------------------------------------------
    # Task 4: Display Switches to be Added (for verification)
    # ------------------------------------------------------------------------
    # Show which switches will be added to each fabric. If the list is empty,
    # all switches are already registered.
    # ------------------------------------------------------------------------
    - name: Display Switches to be Added per Fabric
      debug:
        msg:
          - "Fabric: {{ item.fabric_name }}"
          - "Switches to be Added: {{ item.switches | map(attribute='hostname') | list }}"
      loop: "{{ switches_to_add }}"

    # ------------------------------------------------------------------------
    # Task 5: Add Missing Switches to Fabrics
    # ------------------------------------------------------------------------
    # For each fabric with missing switches:
    #   1. Render the add_switches_to_fabric.json.j2 template
    #   2. POST to /api/v1/manage/fabrics/{fabric_name}/switches
    #   3. ND will discover and onboard the switches
    #
    # Key Settings:
    #   - preserveConfig: true = Keep existing switch configurations
    #   - platformType: nx-os = Cisco NX-OS switches
    #   - useCredentialForWrite: true = Use provided credentials for config writes
    #   - timeout: 300 = Wait up to 5 minutes (switch addition can be slow)
    #
    # Condition: Only execute if there are switches to add (length > 0)
    # ------------------------------------------------------------------------
    - name: Add Switches to Nexus Dashboard Fabrics
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ nd_login_domain }}"
        method: POST                                      # HTTP POST to add switches
        path: /api/v1/manage/fabrics/{{ item.fabric_name }}/switches  # API endpoint
        timeout: 300                                      # Extended timeout for switch discovery
        content: "{{ lookup('template', '../templates/add_switches_to_fabric.json.j2') }}"  # JSON payload
      loop: "{{ switches_to_add }}"                       # Loop through fabrics with switches to add
      when: item.switches | length > 0                   # Skip if no switches to add
