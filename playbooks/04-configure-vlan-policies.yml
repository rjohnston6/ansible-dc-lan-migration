---
# ============================================================================
# Playbook: Configure and Deploy VLAN Policies to Nexus Dashboard
# ============================================================================
# Purpose:
#   - Load the VLAN database generated from existing switch configurations
#   - Deploy VLAN policies to Nexus Dashboard for the target fabric
#   - Associate each VLAN with the appropriate switches where it should exist
#
# Prerequisites:
#   - VLAN database must exist at fabrics/{target_fabric}/vlan_database.yml
#   - Fabric must already be configured on Nexus Dashboard
#   - Switches must be added to the fabric
#   - VLAN policy template (create_vlan) must exist on Nexus Dashboard
#
# Usage:
#   ansible-playbook playbooks/04-configure-vlan-policies.yml
#   ansible-playbook playbooks/04-configure-vlan-policies.yml -e "target_fabric=mgmt-fabric"
#   ansible-playbook playbooks/04-configure-vlan-policies.yml -e "deploy_policy=false"
#
# Tags:
#   configure-vlan-policies: Deploy VLAN policies to Nexus Dashboard
# ============================================================================

- name: Configure and assign the VLAN policies for each fabric
  hosts: nexus_dashboard
  gather_facts: false

  tags:
    - configure-vlan-policies

  vars:
    # Target fabric name - must match fabric name in Nexus Dashboard
    target_fabric: mgmt-fabric
    
    # Whether to deploy policies immediately (true) or stage them for later deployment (false)
    deploy_policy: true

  tasks:

    # ------------------------------------------------------------------------
    # Task 1: Load VLAN Database
    # ------------------------------------------------------------------------
    # Read the VLAN database YAML file generated by playbook 01-profile-existing-switches.yml
    # The file contains a list of VLANs with their IDs, names, and switch associations
    # Format: { vlans: [ { vlan_id: X, name: Y, switches: [ip1, ip2, ...] }, ... ] }
    # ------------------------------------------------------------------------
    - name: Load VLAN Database for Target Fabric
      set_fact:
        fabric_vlans: "{{ (lookup('file', '../fabrics/' + target_fabric + '/vlan_database.yml') | from_yaml).vlans }}"

    # ------------------------------------------------------------------------
    # Task 2: Deploy VLAN Policies
    # ------------------------------------------------------------------------
    # Create and deploy VLAN policies using the dcnm_policy module
    # 
    # Process:
    #   1. Loop through each VLAN in the fabric_vlans list
    #   2. Render the deploy_vlans.yml.j2 template for each VLAN
    #   3. The template generates a policy configuration with:
    #      - Policy name: create_vlan
    #      - Policy variables: VLAN ID and NAME
    #      - Target switches: List of switch IPs where the VLAN should exist
    #   4. Submit the policy to Nexus Dashboard
    #   5. If deploy_policy=true, deploy immediately; otherwise stage for later
    #
    # Note: The create_vlan policy template must exist on Nexus Dashboard
    # and should be configured to create VLANs with the specified ID and name
    # ------------------------------------------------------------------------
    - name: Deploy VLAN Policies to Nexus Dashboard
      cisco.dcnm.dcnm_policy:
        fabric: "{{ target_fabric }}"              # Target fabric name
        state: merged                               # Merge with existing policies
        deploy: "{{ deploy_policy }}"              # Deploy immediately or stage
        config: "{{ lookup('template', '../templates/deploy_vlans.yml.j2') | from_yaml }}"  # Rendered policy config
      loop: "{{ fabric_vlans }}"                    # Iterate over all VLANs
      loop_control:
        label: "VLAN {{ item.vlan_id }} - {{ item.name }} - Switches: {{ item.switches | join(', ') }}"  # Display friendly label
