---
# Playbook: 1.3-preprovision-portchannel.yml
# Purpose: Configure port-channel interfaces on pre-provisioned switches via NDFC
#
# Description:
#   This playbook configures port-channel interfaces for uplinks on switches by:
#   1. Loading l2_interfaces.yml to find port-channel interfaces
#   2. Filtering switches with add_to_fabric: true
#   3. Extracting port-channel configuration (members, VLANs, native VLAN)
#   4. Calling the globalInterface API to configure each port-channel
#
# Prerequisites:
#   - Run 1.2-preprovision-uplink-interfaces.yml first to configure member interfaces
#
# Variables Required (per switch in hosts.yml):
#   - add_to_fabric: Set to true to include switch in provisioning
#   - fabric: Target fabric name
#   - destination_switch_sn: Target switch serial number
#
# Variables from l2_interfaces.yml:
#   - switches.<hostname>.interfaces: List of interfaces
#   - interfaces[].type: Interface type (pc for port-channel)
#   - interfaces[].members: List of member interfaces
#   - interfaces[].trunk.allowed_vlans: Allowed VLANs
#   - interfaces[].trunk.native_vlan: Native VLAN
#
# API Endpoints Used:
#   - POST /appcenter/cisco/ndfc/api/v1/lan-fabric/rest/globalInterface
#
# Templates Used:
#   - uplink_portchannel_interface.json.j2: JSON template for port-channel config
#
# Tags:
#   - preprovision-portchannel: Run only port-channel provisioning tasks
#
# Example Usage:
#   ansible-playbook ./playbooks/provision-access/1.3-preprovision-portchannel.yml
#   ansible-playbook ./playbooks/provision-access/1.3-preprovision-portchannel.yml --tags preprovision-portchannel

- name: Configure Port-Channel Interfaces on Pre-provisioned Switches
  hosts: nexus_dashboard
  gather_facts: false

  tags:
    - preprovision-portchannel

  tasks:

    # Build list of switches to provision
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    - name: Display switches to provision port-channels
      ansible.builtin.debug:
        msg: |
          Switches to provision port-channels: {{ switches_to_provision | length }}
          {% for switch in switches_to_provision %}
          - {{ switch.inventory_hostname }}: fabric={{ switch.fabric }}, serial={{ switch.destination_switch_sn | default('N/A') }}
          {% endfor %}

    # Load L2 interfaces from all fabrics
    - name: Find all l2_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l2_interfaces.yml"
        recurse: true
      register: l2_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load L2 interfaces data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "l2_data_{{ item.path | dirname | basename }}"
      loop: "{{ l2_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    # Build consolidated L2 interfaces lookup
    - name: Build consolidated L2 interfaces lookup
      ansible.builtin.set_fact:
        l2_interfaces_lookup: |
          {%- set lookup = {} -%}
          {%- for file in l2_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'l2_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: data.interfaces | default([])}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    # Extract port-channel interfaces
    - name: Build port-channel interface configurations
      ansible.builtin.set_fact:
        portchannel_interfaces: |
          {%- set interfaces = [] -%}
          {%- for switch in switches_to_provision -%}
            {%- set hostname = switch.inventory_hostname -%}
            {%- set serial = switch.destination_switch_sn | default('') -%}
            {%- set fabric = switch.fabric | default('') -%}
            {%- if serial and hostname in l2_interfaces_lookup -%}
              {%- set switch_interfaces = l2_interfaces_lookup[hostname] -%}
              {%- for iface in switch_interfaces -%}
                {%- if iface.name is defined and iface.name | lower is search('^port-channel') -%}
                  {%- set member_list = [] -%}
                  {%- set pc_mode = 'active' -%}
                  {%- if iface.members is defined -%}
                    {%- for member in iface.members -%}
                      {%- set _ = member_list.append(member.interface) -%}
                      {%- if member.mode is defined -%}
                        {%- set pc_mode = member.mode -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                  {%- set pc_iface = {
                    'hostname': hostname,
                    'serial_number': serial,
                    'fabric_name': fabric,
                    'port_channel_name': iface.name,
                    'member_interfaces': member_list | join(','),
                    'pc_mode': pc_mode,
                    'allowed_vlans': iface.trunk.allowed_vlans | default('none') if iface.trunk is defined else 'none',
                    'native_vlan': iface.trunk.native_vlan | default('') | string if iface.trunk is defined else '',
                    'description': iface.description | default('')
                  } -%}
                  {%- set _ = interfaces.append(pc_iface) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ interfaces }}
      when: switches_to_provision | length > 0

    - name: Display port-channel interfaces to configure
      ansible.builtin.debug:
        msg: |
          Port-channel interfaces to configure: {{ portchannel_interfaces | length }}
          {% for iface in portchannel_interfaces %}
          - {{ iface.hostname }}: {{ iface.port_channel_name }} (members: {{ iface.member_interfaces }}, vlans: {{ iface.allowed_vlans }}, native: {{ iface.native_vlan | default('none') }})
          {% endfor %}
      when:
        - switches_to_provision | length > 0
        - portchannel_interfaces is defined

    # Query existing interfaces per switch to make playbook idempotent
    - name: Get unique serial numbers from port-channel interfaces
      ansible.builtin.set_fact:
        unique_serials: "{{ portchannel_interfaces | map(attribute='serial_number') | unique | list }}"
      when:
        - portchannel_interfaces is defined
        - portchannel_interfaces | length > 0

    - name: Query existing interfaces for each switch
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/interface?serialNumber={{ item }}"
        method: GET
      loop: "{{ unique_serials | default([]) }}"
      loop_control:
        label: "{{ item }}"
      when:
        - unique_serials is defined
        - unique_serials | length > 0
      register: existing_interfaces_query
      ignore_errors: true

    - name: Build set of existing interface names per serial
      ansible.builtin.set_fact:
        existing_interfaces_lookup: |
          {%- set lookup = {} -%}
          {%- for result in existing_interfaces_query.results | default([]) -%}
            {%- if result.current is defined and result.current is iterable and result.current is not string -%}
              {%- set serial = result.item -%}
              {%- set ifaces = [] -%}
              {%- for policy_group in result.current -%}
                {%- if policy_group.interfaces is defined -%}
                  {%- for iface in policy_group.interfaces -%}
                    {%- if iface.ifName is defined -%}
                      {%- set _ = ifaces.append(iface.ifName | lower) -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endfor -%}
              {%- set _ = lookup.update({serial: ifaces}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: existing_interfaces_query is defined

    - name: Filter out already configured port-channel interfaces
      ansible.builtin.set_fact:
        portchannel_interfaces_filtered: |
          {%- set filtered = [] -%}
          {%- for iface in portchannel_interfaces -%}
            {%- set serial = iface.serial_number -%}
            {%- set existing = existing_interfaces_lookup.get(serial, []) -%}
            {%- set pc_name_normalized = iface.port_channel_name | lower | regex_replace('^port-channel', 'port-channel') -%}
            {%- if pc_name_normalized not in existing -%}
              {%- set _ = filtered.append(iface) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ filtered }}
      when:
        - portchannel_interfaces is defined
        - existing_interfaces_lookup is defined

    - name: Display port-channel interfaces to configure (after filtering existing)
      ansible.builtin.debug:
        msg: |
          Port-channel interfaces to configure (excluding existing): {{ portchannel_interfaces_filtered | length }}
          Already configured (skipped): {{ (portchannel_interfaces | length) - (portchannel_interfaces_filtered | length) }}
          {% for iface in portchannel_interfaces_filtered %}
          - {{ iface.hostname }}: {{ iface.port_channel_name }} (members: {{ iface.member_interfaces }}, vlans: {{ iface.allowed_vlans }}, native: {{ iface.native_vlan | default('none') }})
          {% endfor %}
      when: portchannel_interfaces_filtered is defined

    # Configure port-channel interfaces via NDFC API
    - name: Configure port-channel interfaces on switches
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/globalInterface"
        method: POST
        content: "{{ lookup('template', '../../templates/uplink_portchannel_interface.json.j2') }}"
      loop: "{{ portchannel_interfaces_filtered }}"
      loop_control:
        label: "{{ item.hostname }}: {{ item.port_channel_name }}"
      vars:
        serial_number: "{{ item.serial_number }}"
        fabric_name: "{{ item.fabric_name }}"
        port_channel_name: "{{ item.port_channel_name }}"
        member_interfaces: "{{ item.member_interfaces }}"
        pc_mode: "{{ item.pc_mode }}"
        allowed_vlans: "{{ item.allowed_vlans }}"
        native_vlan: "{{ item.native_vlan }}"
        description: "{{ item.description }}"
      when:
        - portchannel_interfaces_filtered is defined
        - portchannel_interfaces_filtered | length > 0
      register: portchannel_results

    - name: Display port-channel configuration results
      ansible.builtin.debug:
        msg: |
          Port-channel configuration complete.
          Already existed (skipped): {{ (portchannel_interfaces | length) - (portchannel_interfaces_filtered | default([]) | length) }}
          {% for result in portchannel_results.results | default([]) %}
          {% if result.skipped is not defined or not result.skipped %}
          - {{ result.item.hostname }}/{{ result.item.port_channel_name }}: {{ 'SUCCESS' if result.failed is not defined or not result.failed else 'FAILED' }}
          {% endif %}
          {% endfor %}
      when: portchannel_results is defined
