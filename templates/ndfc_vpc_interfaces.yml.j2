---
#==============================================================================
# Template: NDFC VPC Interface Configuration Generator
#==============================================================================
# Purpose: Generate cisco.dcnm.dcnm_interface module configuration for VPC
#          (Virtual Port Channel) interfaces from consolidated VPC inventory
#
# Input Variables:
#   - vpc_interface: VPC interface configuration with consolidated data
#     Structure:
#       name: port-channelXX (converted to vpcXX)
#       vpc_id: VPC identifier number
#       switches: [switch1, switch2] - List of VPC peer switches
#       members: {switch1: [members], switch2: [members]} - Port-channel members per switch
#       mode: trunk or access
#       trunk/access: VLAN configuration
#
# Output: Single-entry list with VPC interface configuration spanning both switches
#
# Key Features:
#   - Converts port-channelXX names to vpcXX format for NDFC
#   - Assigns member interfaces to peer1 and peer2 based on switch list order
#   - Handles trunk and access mode configurations
#   - Applies same VPC ID to both peers (peer1_pcid, peer2_pcid, vpc_id)
#==============================================================================

{# Convert port-channel name to vpc format and configure for both switches #}
- name: {{ vpc_interface.name | regex_replace('^port-channel', 'vpc') }}
  switch: {{ vpc_interface.switches }}
  type: {{ vpc_interface.type }}
  deploy: true
  state: {{ vpc_interface.state | default('merged') }}
  admin_state: true
  profile:
{% if vpc_interface.mtu is defined %}
{%   if vpc_interface.mtu == 1500 %}
    mtu: "default"
{%   elif vpc_interface.mtu >= 9000 %}
    mtu: "jumbo"
{%   endif %}
{% else %}
    mtu: "default"
{% endif %}
{% if vpc_interface.mode == 'trunk' %}
    mode: trunk
    bpdu_guard: false
{% if vpc_interface.trunk is defined and vpc_interface.trunk.allowed_vlans is defined %}
    peer1_allowed_vlans: {{ vpc_interface.trunk.allowed_vlans }}
    peer2_allowed_vlans: {{ vpc_interface.trunk.allowed_vlans }}
{% endif %}
{% if vpc_interface.trunk is defined and vpc_interface.trunk.native_vlan is defined %}
    peer1_native_vlan: {{ vpc_interface.trunk.native_vlan }}
    peer2_native_vlan: {{ vpc_interface.trunk.native_vlan }}
{% endif %}
{% elif vpc_interface.mode == 'access' %}
    mode: access
{% if vpc_interface.access is defined and vpc_interface.access.vlan is defined %}
    access_vlan: {{ vpc_interface.access.vlan }}
{% endif %}
{% endif %}
{% if vpc_interface.description is defined %}
    description: "{{ vpc_interface.description }}"
{% endif %}
{% if vpc_interface.lacp_suspend is defined %}
    disable_lacp_suspend_individual: {{ vpc_interface.lacp_suspend }}
{% else %}
    disable_lacp_suspend_individual: false
{% endif %}
{#================ Port-Channel Member Interfaces =================#}
{# Member interfaces are assigned per peer switch #}
{#===============================================================#}
{# Note: Members are defined as a dictionary mapping switch names to lists #}
{# of member interfaces. We extract members for peer1 and peer2 based on #}
{# the order of switches in the 'switches' list. #}
{#===============================================================#}
{# VPC configuration - same VPC ID applied to both peers #}
    peer1_pcid: {{ vpc_interface.vpc_id }}
    peer2_pcid: {{ vpc_interface.vpc_id }}
    vpc_id: {{ vpc_interface.vpc_id }}
{# Port-channel member interfaces assigned per peer switch #}
{% if vpc_interface.members is defined %}
{%   set switch_list = vpc_interface.switches %}
{%   if switch_list | length >= 1 %}
{%     set peer1_members = vpc_interface.members[switch_list[0]] | default([]) %}
    peer1_members:
{%     for member in peer1_members %}
      - {{ member.interface }}
{%     endfor %}
{%   endif %}
{%   if switch_list | length >= 2 %}
{%     set peer2_members = vpc_interface.members[switch_list[1]] | default([]) %}
    peer2_members:
{%     for member in peer2_members %}
      - {{ member.interface }}
{%     endfor %}
{%   endif %}
{% endif %}
