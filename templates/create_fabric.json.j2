{#
  Template: create_fabric.json.j2
  Purpose: Transform Ansible fabric variables into Nexus Dashboard API JSON format

  Description:
    This Jinja2 template converts fabric configuration variables from
    host_vars/nexus_dashboard/fabric_definitions.yml into the JSON structure
    required by the Nexus Dashboard Fabrics API.

  Input Variables (item.*):
    Required:
      - FABRIC_NAME: Name of the fabric
      - FABRIC_TYPE: Type of fabric (classicLan, vxlanIbgp, etc.)

    Common Optional:
      - LICENSE_TIER: License level (essentials, advantage, premier)
      - IS_READ_ONLY: Monitor-only mode (true/false)
      - PM_ENABLE: Performance monitoring (true/false)
      - POWER_REDUNDANCY_MODE: Power redundancy (ps-redundant, redundant, combined)
      - BOOTSTRAP_ENABLE: Enable day0 bootstrap (true/false)
      - DHCP_ENABLE: Enable DHCP server (true/false)
      - DHCP_START/DHCP_END: DHCP IP range
      - MGMT_GW: Management gateway IP
      - MGMT_PREFIX: Management subnet prefix length
      - INBAND_MGMT: Enable in-band management (true/false)
      - ENABLE_NXAPI: Enable NX-API (true/false)

  API Endpoint:
    POST/PUT /api/v1/manage/fabrics

  Usage Context:
    Used by playbook 02-configure-nd-fabric.yml to create/update fabrics
    Called via: lookup('template', '../templates/create_fabric.json.j2')

  Notes:
    - Supports both Classic LAN and VXLAN fabric types
    - Provides sensible defaults for most optional parameters
    - Conditionally includes parameters based on fabric type
    - All boolean values converted to lowercase for JSON compliance
#}
{
  "name": "{{ item.FABRIC_NAME }}",
  "location": {
    "latitude": 0,
    "longitude": 0
  },
  "licenseTier": "{{ item.LICENSE_TIER | default('essentials') }}",
  "alertSuspend": "disabled",
  "telemetryCollection": false,
  "telemetryCollectionType": "outOfBand",
  "telemetryStreamingProtocol": "ipv4",
  "telemetrySourceInterface": "loopback0",
  "telemetrySourceVrf": "default",
  "securityDomain": "all",
  "management": {
    "type": "{{ item.FABRIC_TYPE | default('vxlanIbgp') }}",
{% if item.FABRIC_TYPE is defined and item.FABRIC_TYPE == 'classicLan' %}
    "monitoredMode": {{ item.IS_READ_ONLY | default(false) | lower }},
    "performanceMonitoring": {{ item.PM_ENABLE | default(false) | lower }},
    "powerRedundancyMode": "{{ item.POWER_REDUNDANCY_MODE | default('redundant') }}",
    "mplsHandoff": {{ item.MPLS_HANDOFF | default(false) | lower }},
{% if item.MPLS_HANDOFF is defined and item.MPLS_HANDOFF %}
    "mplsLoopbackIdentifier": {{ item.MPLS_LB_ID | default(0) }},
{% endif %}
    "advancedSshOption": {{ item.ADVANCED_SSH_OPTION | default(false) | lower }},
    "snmpTrap": {{ item.SNMP_TRAP | default(true) | lower }},
    "cdp": {{ item.CDP_ENABLE | default(false) | lower }},
    "nxapi": {{ item.ENABLE_NXAPI | default(false) | lower }},
{% if item.ENABLE_NXAPI is defined and item.ENABLE_NXAPI %}
    "nxapiHttpsPort": {{ item.NXAPI_HTTPS_PORT | default(443) }},
    "nxapiHttp": {{ item.NXAPI_HTTP_ENABLE | default(false) | lower }},
{% if item.NXAPI_HTTP_ENABLE is defined and item.NXAPI_HTTP_ENABLE %}
    "nxapiHttpPort": {{ item.NXAPI_HTTP_PORT | default(80) }},
{% endif %}
{% endif %}
    "inbandManagement": {{ item.INBAND_MGMT | default(false) | lower }},
    "ptp": {{ item.PTP | default(false) | lower }},
{% if item.PTP is defined and item.PTP %}
    "ptpLoopbackId": {{ item.PTP_LB_ID | default(0) }},
    "ptpDomainId": {{ item.PTP_DOMAIN_ID | default(0) }},
{% endif %}
    "realTimeInterfaceStatisticsCollection": {{ item.REAL_TIME_STATS | default(false) | lower }},
{% if item.REAL_TIME_STATS is defined and item.REAL_TIME_STATS %}
    "interfaceStatisticsLoadInterval": {{ item.INTERFACE_STATS_LOAD_INTERVAL | default(10) }},
{% endif %}
    "coppPolicy": "{{ item.COPP_POLICY | default('manual') }}",
    "extraConfigFabric": "{{ item.EXTRA_CONFIG_FABRIC | default('') }}",
    "extraConfigAaa": "{{ item.EXTRA_CONFIG_AAA | default('') }}",
    "subInterfaceDot1qRange": "{{ item.SUBINTERFACE_DOT1Q_RANGE | default('2-511') }}",
    "mplsLoopbackIpRange": "{{ item.MPLS_LB_IP_RANGE | default('10.102.0.0/25') }}",
    "realTimeBackup": {{ item.REAL_TIME_BACKUP | default(true) | lower }},
    "scheduledBackup": {{ item.SCHEDULED_BACKUP | default(false) | lower }},
{% if item.SCHEDULED_BACKUP is defined and item.SCHEDULED_BACKUP %}
    "scheduledBackupTime": "{{ item.BACKUP_TIME | default('') }}",
{% endif %}
    "day0Bootstrap": {{ item.BOOTSTRAP_ENABLE | default(false) | lower }},
{% if item.BOOTSTRAP_ENABLE is defined and item.BOOTSTRAP_ENABLE %}
    "inbandDay0Bootstrap": {{ item.INBAND_ENABLE | default(false) | lower }},
    "localDhcpServer": {{ item.DHCP_ENABLE | default(false) | lower }},
    "dhcpProtocolVersion": "dhcpv4",
    "dhcpStartAddress": "{{ item.DHCP_START | default('') }}",
    "dhcpEndAddress": "{{ item.DHCP_END | default('') }}",
    "managementGateway": "{{ item.MGMT_GW | default('') }}",
    "managementIpv4Prefix": {{ item.MGMT_PREFIX | default(24) }},
    "managementIpv6Prefix": {{ item.MGMT_IPV6_PREFIX | default(64) }},
    "aaa": {{ item.AAA_ENABLE | default(false) | lower }},
    "extraConfigNxosBootstrap": "{{ item.EXTRA_CONFIG_BOOTSTRAP | default('') }}",
    "bootstrapSubnetCollection": {{ item.BOOTSTRAP_SUBNETS | default([]) | to_json }}
{% endif %}
{% endif %}
  },
  "telemetrySettings": {
    "flowCollection": {
      "trafficAnalytics": "{{ item.TRAFFIC_ANALYTICS | default('disabled') }}",
      "flowCollectionModes": {
        "netFlow": {{ item.NETFLOW_ENABLE | default(false) | lower }},
        "sFlow": {{ item.SFLOW_ENABLE | default(false) | lower }},
        "flowTelemetry": {{ item.FLOW_TELEMETRY_ENABLE | default(false) | lower }}
      },
      "udpCategorization": "{{ item.UDP_CATEGORIZATION | default('disabled') }}"
    },
    "microburst": {
      "microburst": {{ item.MICROBURST_ENABLE | default(false) | lower }},
      "sensitivity": "{{ item.MICROBURST_SENSITIVITY | default('low') }}"
    },
    "analysisSettings": {
      "isEnabled": {{ item.ANALYSIS_ENABLE | default(false) | lower }}
    }
  },
  "externalStreamingSettings": {
    "email": [],
    "messageBus": [],
    "syslog": {
      "collectionSettings": {
        "anomalies": []
      },
      "facility": "",
      "servers": []
    }
  }
}
