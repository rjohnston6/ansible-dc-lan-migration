{#
================================================================================
Template: VPC Domain Configuration for Nexus Dashboard DCNM
================================================================================
Purpose:
  Generate JSON payload for deploying VPC (Virtual Port Channel) domain
  configuration to Nexus Dashboard via the DCNM REST API. Configures the
  VPC domain parameters, peer-link, and keepalive settings.

API Endpoint:
  POST /appcenter/cisco/ndfc/api/v1/lan-fabric/rest/vpcpair

Input Variables (from playbook loop):
  item.PEER_ONE_ID              - Serial number of first VPC peer switch (from ND)
  item.PEER_TWO_ID              - Serial number of second VPC peer switch (from ND)
  item.FABRIC_NAME              - Name of the fabric containing the VPC pair
  item.DOMAIN_ID                - VPC domain ID (must be unique in fabric)
  item.PEER1_KEEP_ALIVE_LOCAL_IP - Keepalive source IP for peer 1
  item.PEER2_KEEP_ALIVE_LOCAL_IP - Keepalive source IP for peer 2
  item.KEEP_ALIVE_VRF           - VRF for keepalive (typically 'management')
  item.PEER1_PCID               - Port-channel ID for peer-link on peer 1
  item.PEER2_PCID               - Port-channel ID for peer-link on peer 2
  item.PEER1_MEMBER_INTERFACES  - List of interfaces in peer-link on peer 1
  item.PEER2_MEMBER_INTERFACES  - List of interfaces in peer-link on peer 2
  item.ALLOWED_VLANS            - VLANs allowed on peer-link

Optional Variables:
  item.VIRTUAL_PEER_LINK        - Use virtual peer-link (FabricPath)
  item.IS_VPC_PLUS              - Enable VPC+ (FabricPath integration)
  item.IS_VTEPS                 - Configure as VXLAN VTEPs
  item.KEEP_ALIVE_HOLD_TIMEOUT  - Keepalive timeout (default: 3 seconds)
  item.PC_MODE                  - Port-channel mode (default: 'active')

Output Structure:
  JSON object with:
    - peerOneId/peerTwoId: Switch serial numbers
    - templateName: Policy template name on ND ('vpc_pair')
    - nvPairs: Name-value pairs for template variables

Notes:
  - Serial numbers must match what ND has registered for the switches
  - Member interfaces are converted from list to comma-separated string
  - nvPairs is a JSON object (not a string) for proper API parsing
  - Template uses vpc_pair policy template which must exist on ND
================================================================================
#}
{
  "useVirtualPeerLink": {{ item.VIRTUAL_PEER_LINK | default(false) | lower }},  {# Enable virtual peer-link #}
  "peerOneId": "{{ item.PEER_ONE_ID | default('') }}",                         {# First peer serial number #}
  "peerTwoId": "{{ item.PEER_TWO_ID | default('') }}",                         {# Second peer serial number #}
  "templateName": "{{ item.TEMPLATE_NAME | default('vpc_pair') }}",            {# ND policy template name #}
  "nvPairs": {                                                                  {# Template parameters #}                                                                  {# Template parameters #}
    "FABRIC_NAME": "{{ item.FABRIC_NAME | default('') }}",                       {# Target fabric name #}
    "DOMAIN_ID": "{{ item.DOMAIN_ID | default('1') }}",                          {# VPC domain ID #}
    "PEER1_KEEP_ALIVE_LOCAL_IP": "{{ item.PEER1_KEEP_ALIVE_LOCAL_IP | default('') }}",  {# Peer 1 keepalive source IP #}
    "PEER2_KEEP_ALIVE_LOCAL_IP": "{{ item.PEER2_KEEP_ALIVE_LOCAL_IP | default('') }}",  {# Peer 2 keepalive source IP #}
    "KEEP_ALIVE_VRF": "{{ item.KEEP_ALIVE_VRF | default('management') }}",      {# VRF for keepalive #}
    "KEEP_ALIVE_HOLD_TIMEOUT": "{{ item.KEEP_ALIVE_HOLD_TIMEOUT | default('3') }}",  {# Keepalive timeout (seconds) #}
    "isVpcPlus": {{ item.IS_VPC_PLUS | default(false) | lower }},               {# Enable VPC+ (FabricPath) #}
    {% if item.IS_VPC_PLUS is defined and item.IS_VPC_PLUS %}                   {# VPC+ specific config #}
    "fabricPath_switch_id": "{{ item.FABRICPATH_SWITCH_ID | default('') }}",    {# FabricPath switch ID #}
    {% endif %}
    "isVTEPS": {{ item.IS_VTEPS | default(false) | lower }},                    {# Configure as VXLAN VTEPs #}
    {% if item.IS_VTEPS is defined and item.IS_VTEPS %}                         {# VXLAN VTEP config #}
    "NVE_INTERFACE": "{{ item.NVE_INTERFACE | default('') }}",                  {# NVE interface number #}
    "PEER1_SOURCE_LOOPBACK": "{{ item.PEER1_SOURCE_LOOPBACK | default('') }}",  {# Peer 1 VTEP source loopback #}
    "PEER2_SOURCE_LOOPBACK": "{{ item.PEER2_SOURCE_LOOPBACK | default('') }}",  {# Peer 2 VTEP source loopback #}
    "PEER1_PRIMARY_IP": "{{ item.PEER1_PRIMARY_IP | default('') }}",            {# Peer 1 primary VTEP IP #}
    "PEER2_PRIMARY_IP": "{{ item.PEER2_PRIMARY_IP | default('') }}",            {# Peer 2 primary VTEP IP #}
    "LOOPBACK_SECONDARY_IP": "{{ item.LOOPBACK_SECONDARY_IP | default('') }}",  {# Secondary anycast VTEP IP #}
    {% endif %}
    "PEER1_DOMAIN_CONF": "{{ item.PEER1_DOMAIN_CONF | default('') }}",          {# Peer 1 additional domain config #}
    "PEER2_DOMAIN_CONF": "{{ item.PEER2_DOMAIN_CONF | default('') }}",          {# Peer 2 additional domain config #}
    "clear_policy": {{ item.CLEAR_POLICY | default('false') }},                 {# Clear existing policy #}
    "PEER1_PCID": "{{ item.PEER1_PCID | default('') }}",                        {# Peer 1 peer-link port-channel ID #}
    "PEER2_PCID": "{{ item.PEER2_PCID | default('') }}",                        {# Peer 2 peer-link port-channel ID #}
    "PEER1_MEMBER_INTERFACES": "{{ item.PEER1_MEMBER_INTERFACES | join(',') if item.PEER1_MEMBER_INTERFACES is iterable and item.PEER1_MEMBER_INTERFACES is not string else item.PEER1_MEMBER_INTERFACES | default('') }}",  {# Peer 1 peer-link members (comma-separated) #}
    "PEER2_MEMBER_INTERFACES": "{{ item.PEER2_MEMBER_INTERFACES | join(',') if item.PEER2_MEMBER_INTERFACES is iterable and item.PEER2_MEMBER_INTERFACES is not string else item.PEER2_MEMBER_INTERFACES | default('') }}",  {# Peer 2 peer-link members (comma-separated) #}
    "PC_MODE": "{{ item.PC_MODE | default('active') }}",                        {# Port-channel mode (active/passive) #}
    "PEER1_PO_DESC": "{{ item.PEER1_PO_DESC | default('') }}",                  {# Peer 1 port-channel description #}
    "PEER2_PO_DESC": "{{ item.PEER2_PO_DESC | default('') }}",                  {# Peer 2 port-channel description #}
    "ADMIN_STATE": "{{ item.ADMIN_STATE | default('true') }}",                  {# Administrative state #}
    "ALLOWED_VLANS": "{{ item.ALLOWED_VLANS | default('all') }}",               {# VLANs allowed on peer-link #}
    "PEER1_NATIVE_VLAN": "{{ item.PEER1_NATIVE_VLAN | default('1') }}",        {# Peer 1 native VLAN #}
    "PEER2_NATIVE_VLAN": "{{ item.PEER2_NATIVE_VLAN | default('1') }}",        {# Peer 2 native VLAN #}
    "PEER1_PO_CONF": "{{ item.PEER1_PO_CONF | default('') }}",                  {# Peer 1 additional port-channel config #}
    "PEER2_PO_CONF": "{{ item.PEER2_PO_CONF | default('') }}"                   {# Peer 2 additional port-channel config #}
  }
}