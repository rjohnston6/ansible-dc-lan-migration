{#
================================================================================
Template: Ethernet Interface Configuration for dcnm_interface Module
================================================================================
Purpose:
  Generate Ethernet interface configuration list for the cisco.dcnm.dcnm_interface
  module to deploy L2 access and trunk interfaces to NDFC.

Module: cisco.dcnm.dcnm_interface
  - type: eth (Ethernet interface)
  - state: replaced (idempotent configuration)

Input Variables:
  switches_to_provision      - List of switches with add_to_fabric: true
  l2_interfaces_lookup       - Consolidated interface data per switch

Output:
  List of Ethernet interface configurations in dcnm_interface format

Interface Naming:
  - Input: Ethernet1/3
  - Output: eth1/3 (dcnm_interface format)

Supported Modes:
  - access: Single VLAN access port with BPDU guard
  - trunk: Multiple VLANs with native VLAN and BPDU guard

Port-channel Members:
  Discovery now writes every physical interface (including port-channel members)
  as standalone eth entries in l2_interfaces.yml. Members carry their actual
  L2 config (mode/vlan from nxos_l2_interfaces) plus a channel_group field
  indicating which port-channel they belong to. This template processes them
  normally alongside non-member Ethernet interfaces; no auto-extraction needed.

================================================================================
#}
{% set config = [] %}
{% for switch in switches_to_provision %}
  {% set switch_name = switch.inventory_hostname %}
  {% if switch_name in l2_interfaces_lookup %}
    {% set switch_ip = hostvars[switch_name]['ansible_host'] %}
    {# --- Standard Ethernet interfaces (excluding port-channel members - NDFC manages member config via the port-channel) --- #}
    {% set eth_interfaces = l2_interfaces_lookup[switch_name].interfaces | selectattr('type', 'equalto', 'eth') | list %}
    {% for iface in eth_interfaces %}
      {# Skip port-channel members - their L2 config is inherited from the PC in NDFC #}
      {# Skip interfaces with no explicit mode (e.g. unconfigured/admin-down only ports) #}
      {% if iface.mode is defined and iface.channel_group is not defined %}
      {% set iface_name = iface.name | regex_replace('^Ethernet', 'eth') %}
      {% set iface_config = {
        'name': iface_name,
        'type': 'eth',
        'switch': [switch_ip],
        'deploy': false,
        'profile': {
          'admin_state': iface.enabled | default(true),
          'mode': iface.mode,
          'description': iface.description | default('')
        }
      } %}
      {% if iface.mode == 'trunk' %}
        {% set _ = iface_config.profile.update({
          'allowed_vlans': iface.trunk.allowed_vlans | default('all'),
          'native_vlan': iface.trunk.native_vlan | default('') | string,
          'bpdu_guard': 'true',
          'port_type_fast': true
        }) %}
      {% elif iface.mode == 'access' %}
        {% set _ = iface_config.profile.update({
          'access_vlan': iface.access.vlan | default('') | string,
          'bpdu_guard': 'true',
          'port_type_fast': true
        }) %}
      {% endif %}
      {% set _ = config.append(iface_config) %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
{{ config | to_json }}
